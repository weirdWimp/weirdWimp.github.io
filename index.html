<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>The Cabin in the City</title>
    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_859455_eaq7v6w8ktj.css">
<meta name="generator" content="Hexo 4.2.1"></head>
<body>
<header class="header">
    <div class="header-inner">
        <div class="header-title">

        </div>
        <nav class="header-nav">
            
            <a href="/" class="header-nav-link" >
                Home
            </a>
            

            
            <a href="/archives" class="header-nav-link">
                Archives
            </a>
            

            
            <a href="/tags" class="header-nav-link">
                Tags
            </a>
            

            
            <a href="/about/" class="header-nav-link">
                About
            </a>
            
        </nav>
    </div>
</header>
<header class="mobile-header">
    <div class="mobile-nav">
        <div class="mobile-nav-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="mobile-nav-title">
            <a href="/" class="mobile-nav-title-link">Guo's Blog</a>
        </div>

    </div>
    <nav class="mobile-menu">
        <ul class="mobile-menu-list">
            <li class="mobile-menu-item">
                <i class="iconfont icon-home"></i>
                <a href="/" class="mobile-nav-link">Home</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-archive"></i>
                <a href="/archives" class="mobile-nav-link">Archives</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-tag"></i>
                <a href="/tags" class="mobile-nav-link">Tags</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-about"></i>
                <a href="/about/" class="mobile-nav-link">About</a>
            </li>
        </ul>
    </nav>
</header>
<div class="main">
    <div class="content-inner">
        <div class="posts">
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/Linux/CSV2Table/">CSV2Table</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2020-06-21</span>
                
                <span class="post-category">
                    
                    <a class="category" href="/categories/Linux/">Linux</a>
                    
                </span>
                
            </div>
            <div class="post-content">
                
                    <h3 id="CSV-转换为表格（支持MD格式的表格）"><a href="#CSV-转换为表格（支持MD格式的表格）" class="headerlink" title="CSV  转换为表格（支持MD格式的表格）"></a><strong>CSV  转换为表格（支持MD格式的表格）</strong></h3><ul>
<li>Shell 使用 utf-8 编码</li>
<li>仅支持 ASCII 字符和占3个字节的字符 （其他字符在UTF-8中可能是2个字节或4个字节，不适用；或者要占据3个字节，但是打印的宽度不等于一个ASCII字符的2倍的情况下，也不适用）</li>
<li>支持表头字段带有颜色（黄色），使用 <code>-c</code> 选项</li>
<li>支持 MD 表格格式，使用 <code>-m</code> 选项</li>
<li>分隔符默认为 <code>，</code>， 使用 <code>-d &quot;delemeter&quot;</code> 指定，delemeter 中的第一个字符会作为分隔符</li>
</ul>
<p><strong>满足上述情况下，才能打印出格式正确的表格</strong></p>
<h3 id="待优化事项"><a href="#待优化事项" class="headerlink" title="待优化事项"></a><strong>待优化事项</strong></h3><ul>
<li>行数增多时，处理的时间明显过长，是由于每个单元格中的值都要计算字节数和字符数，计算打印时要打印的空格字符数</li>
<li>只针对ASCII字符和占三个字节的字符，并且占三个字节的字符的显示宽度是ASCII字符的两倍，其他情况现在还不能正确处理</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SYNOPSIS</span></span><br><span class="line">./toTable.sh -m -v -c -p -n 50 -d <span class="string">","</span> file</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### rule: always use `LF` as the end of lie in linux or unexpected things will drive you crazy</span></span><br><span class="line"><span class="comment">### csv file to md table or normal table</span></span><br><span class="line"><span class="comment">### only ascii and chinese characters allowed in file,and assumes utf-8 is used as charset or it displays not properly </span></span><br><span class="line"></span><br><span class="line">oldIFS=<span class="variable">$IFS</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">ExitFunc</span></span>() &#123;</span><br><span class="line">    IFS=<span class="variable">$oldIFS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">printSymbolLie</span></span>() &#123;</span><br><span class="line">    sep=<span class="variable">$1</span></span><br><span class="line">    mid=<span class="variable">$2</span></span><br><span class="line">    <span class="built_in">shift</span> 2</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$sep</span>"</span></span><br><span class="line">    <span class="keyword">for</span> count <span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span>; <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">for</span> ((m = -2; m &lt; <span class="variable">$count</span>; m++)); <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$mid</span>"</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$sep</span>"</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">trap</span> <span class="string">'ExitFunc'</span> 2 9 15 20 EXIT</span><br><span class="line"></span><br><span class="line">isMD=0</span><br><span class="line">isColor=0</span><br><span class="line">IFS=,</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">'cmd:'</span> OPT; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"<span class="variable">$OPT</span>"</span> <span class="keyword">in</span></span><br><span class="line">    c)</span><br><span class="line">        isColor=1</span><br><span class="line">        ;;</span><br><span class="line">    m)</span><br><span class="line">        isMD=1</span><br><span class="line">        ;;</span><br><span class="line">    d)</span><br><span class="line">        IFS=$(<span class="built_in">echo</span> -ne <span class="string">"<span class="variable">$OPTARG</span>"</span>)</span><br><span class="line">        ;;</span><br><span class="line">    ?)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"avaliable options: [-c] [-m] [-d delimiter]"</span> &gt;&amp;2 <span class="comment">## standard error</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">        ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">shift</span> <span class="string">"<span class="variable">$(($OPTIND - 1)</span>)"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"delimiter has been set to [<span class="variable">$IFS</span>]"</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">"<span class="variable">$IFS</span>"</span> | hexdump -C</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> <span class="variable">$@</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -f <span class="string">"<span class="variable">$item</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"file <span class="variable">$&#123;item&#125;</span> not exists"</span></span><br><span class="line">        <span class="built_in">continue</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"file name: <span class="variable">$item</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># array contasing all line per file</span></span><br><span class="line">    line_arr=()</span><br><span class="line">    col_count=0</span><br><span class="line">    row_count=0</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span></span><br><span class="line">        line_arr[<span class="variable">$row_count</span>]=<span class="variable">$line</span></span><br><span class="line">        arr=(<span class="variable">$line</span>)</span><br><span class="line">        temp_count=<span class="variable">$&#123;#arr[@]&#125;</span></span><br><span class="line">        <span class="keyword">if</span> ((temp_count &gt; col_count)); <span class="keyword">then</span></span><br><span class="line">            col_count=<span class="variable">$temp_count</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        ((row_count++))</span><br><span class="line">    <span class="keyword">done</span> &lt;<span class="variable">$item</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"table column size: <span class="variable">$&#123;col_count&#125;</span>, row size: <span class="variable">$&#123;row_count&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># array contains max length of every col</span></span><br><span class="line">    max_count_arr=()</span><br><span class="line">    <span class="keyword">for</span> ((i = 0; i &lt; <span class="variable">$&#123;row_count&#125;</span>; i++)); <span class="keyword">do</span></span><br><span class="line">        line=<span class="variable">$&#123;line_arr[i]&#125;</span></span><br><span class="line">        arr=(<span class="variable">$line</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># echo "line: $line $&#123;arr[@]&#125;"</span></span><br><span class="line">        <span class="keyword">for</span> ((j = 0; j &lt; <span class="variable">$col_count</span>; j++)); <span class="keyword">do</span></span><br><span class="line">            max_length=<span class="variable">$&#123;max_count_arr[j]&#125;</span></span><br><span class="line">            col_str=<span class="variable">$&#123;arr[j]&#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># wc output: always in the following order: newline, word, character, byte, maximum line length.</span></span><br><span class="line">            bytes_chars=($(<span class="built_in">echo</span> -n <span class="variable">$col_str</span> | wc -c -m | xargs -n 1 <span class="built_in">echo</span> -n <span class="string">","</span>))</span><br><span class="line">            bytes=<span class="variable">$&#123;bytes_chars[2]&#125;</span></span><br><span class="line">            chars=<span class="variable">$&#123;bytes_chars[1]&#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((bytes &gt; chars)); <span class="keyword">then</span></span><br><span class="line">                current_length=$(((bytes + chars) / 2))</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                current_length=<span class="variable">$chars</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((current_length &gt; max_length)); <span class="keyword">then</span></span><br><span class="line">                max_count_arr[j]=<span class="variable">$current_length</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"max width of every col: <span class="variable">$&#123;max_count_arr[@]&#125;</span>\n"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ((i = 0; i &lt; <span class="variable">$&#123;row_count&#125;</span>; i++)); <span class="keyword">do</span></span><br><span class="line">        line=<span class="variable">$&#123;line_arr[i]&#125;</span></span><br><span class="line">        arr=(<span class="variable">$line</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [[ <span class="variable">$isMD</span> -eq 1 &amp;&amp; <span class="variable">$i</span> -eq 1 ]]; <span class="keyword">then</span></span><br><span class="line">            printSymbolLie <span class="string">"|"</span> <span class="string">"-"</span> <span class="string">"<span class="variable">$&#123;max_count_arr[@]&#125;</span>"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># print the table head line +-------+-------+</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="variable">$isMD</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> [[ <span class="variable">$i</span> -eq 0 || <span class="variable">$i</span> -eq 1 ]]; <span class="keyword">then</span></span><br><span class="line">                printSymbolLie <span class="string">"+"</span> <span class="string">"-"</span> <span class="string">"<span class="variable">$&#123;max_count_arr[@]&#125;</span>"</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ((j = 0; j &lt; <span class="variable">$col_count</span>; j++)); <span class="keyword">do</span></span><br><span class="line">            bytes_chars=($(<span class="built_in">echo</span> -n <span class="variable">$&#123;arr[j]&#125;</span> | wc -c -m | xargs -n 1 <span class="built_in">echo</span> -n <span class="string">","</span>))</span><br><span class="line">            bytes=<span class="variable">$&#123;bytes_chars[2]&#125;</span></span><br><span class="line">            chars=<span class="variable">$&#123;bytes_chars[1]&#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># let's assume x: Chinese char count;  y:ascii char count; default charset is utf-8</span></span><br><span class="line">            <span class="comment"># as for display width: one Chinese character = ascii * 2</span></span><br><span class="line">            <span class="comment">#</span></span><br><span class="line">            <span class="comment"># (1) x*3 + y = bytes (use wc)</span></span><br><span class="line">            <span class="comment"># (2) x + y = chars (use wc)</span></span><br><span class="line">            <span class="comment"># (3) 2*x + y + z = max_width (we have calculated it before, z is the empty char count)</span></span><br><span class="line">            <span class="comment"># </span></span><br><span class="line">            <span class="comment"># printf command will count bytes as min size: printf "%-10s" "hello" 10 means bytes</span></span><br><span class="line">            <span class="comment"># so finally, the printf min size for current col is:</span></span><br><span class="line">            <span class="comment">#       3*x + y + z = max_col_width + (bytes - chars) / 2 (calculated by (1) (2) (3) above)</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((j == 0)); <span class="keyword">then</span> <span class="built_in">echo</span> -n <span class="string">"|"</span>; <span class="keyword">fi</span></span><br><span class="line">            max_col_width=<span class="variable">$&#123;max_count_arr[j]&#125;</span></span><br><span class="line">            min_print=$((max_col_width + (bytes - chars) / 2))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((i == 0 &amp;&amp; isColor == 1)); <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">printf</span> <span class="string">" \033[1;33m%-<span class="variable">$&#123;min_print&#125;</span>s\033[00m |"</span> <span class="variable">$&#123;arr[j]&#125;</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">printf</span> <span class="string">" %-<span class="variable">$&#123;min_print&#125;</span>s |"</span> <span class="variable">$&#123;arr[j]&#125;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="built_in">echo</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print the end line +-------+-------+</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$isMD</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        printSymbolLie <span class="string">"+"</span> <span class="string">"-"</span> <span class="string">"<span class="variable">$&#123;max_count_arr[@]&#125;</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">IFS=<span class="variable">$oldIFS</span></span><br></pre></td></tr></table></figure>





<h3 id="并行计算每列的最大宽度（列粒度）"><a href="#并行计算每列的最大宽度（列粒度）" class="headerlink" title="并行计算每列的最大宽度（列粒度）"></a>并行计算每列的最大宽度（列粒度）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### rule: always use `LF` as the end of lie in linux or unexpected things will drive you crazy</span></span><br><span class="line"><span class="comment">### csv file to md table or normal table</span></span><br><span class="line"><span class="comment">### only ascii and chinese characters allowed in file,or it displays not properly and assumes utf-8 is used as charset</span></span><br><span class="line"></span><br><span class="line">oldIFS=<span class="variable">$IFS</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">log</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"[<span class="variable">$(date +"%F %T")</span>]: <span class="variable">$@</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">ExitFunc</span></span>() &#123;</span><br><span class="line">    IFS=<span class="variable">$oldIFS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">calLength</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> line=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">local</span> start=<span class="variable">$2</span></span><br><span class="line">    <span class="built_in">local</span> end=<span class="variable">$3</span></span><br><span class="line">    <span class="built_in">local</span> arr=(<span class="variable">$line</span>)</span><br><span class="line">    <span class="built_in">local</span> result=<span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((start &lt; end)); <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">local</span> col_str=<span class="variable">$&#123;arr[start]&#125;</span></span><br><span class="line">        <span class="comment"># wc output: always in the following order: newline, word, character, byte, maximum line length.</span></span><br><span class="line">        <span class="built_in">local</span> bytes_chars=($(<span class="built_in">echo</span> -n <span class="variable">$col_str</span> | wc -c -m | xargs -n 1 <span class="built_in">echo</span> -n <span class="string">","</span>))</span><br><span class="line">        <span class="built_in">local</span> bytes=<span class="variable">$&#123;bytes_chars[2]&#125;</span></span><br><span class="line">        <span class="built_in">local</span> chars=<span class="variable">$&#123;bytes_chars[1]&#125;</span></span><br><span class="line">        <span class="keyword">if</span> ((bytes &gt; chars)); <span class="keyword">then</span></span><br><span class="line">            result=<span class="string">"<span class="variable">$&#123;result&#125;</span><span class="variable">$(((bytes + chars)</span> / 2)),"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            result=<span class="string">"<span class="variable">$&#123;result&#125;</span><span class="variable">$chars</span>,"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        ((start++))</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$result</span>"</span> &gt;<span class="string">"col<span class="variable">$2</span>.txt"</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">printSymbolLie</span></span>() &#123;</span><br><span class="line">    sep=<span class="variable">$1</span></span><br><span class="line">    mid=<span class="variable">$2</span></span><br><span class="line">    <span class="built_in">shift</span> 2</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$sep</span>"</span></span><br><span class="line">    <span class="keyword">for</span> count <span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span>; <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">for</span> ((m = -2; m &lt; <span class="variable">$count</span>; m++)); <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$mid</span>"</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$sep</span>"</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">trap</span> <span class="string">'ExitFunc'</span> 2 9 15 20 EXIT</span><br><span class="line"></span><br><span class="line">isMD=0</span><br><span class="line">isColor=0</span><br><span class="line">IFS=,</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">'cmd:'</span> OPT; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"<span class="variable">$OPT</span>"</span> <span class="keyword">in</span></span><br><span class="line">    c)</span><br><span class="line">        isColor=1</span><br><span class="line">        ;;</span><br><span class="line">    m)</span><br><span class="line">        isMD=1</span><br><span class="line">        ;;</span><br><span class="line">    d)</span><br><span class="line">        IFS=$(<span class="built_in">echo</span> -ne <span class="string">"<span class="variable">$OPTARG</span>"</span>)</span><br><span class="line">        ;;</span><br><span class="line">    ?)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"avaliable options: [-c] [-m] [-d delimiter]"</span> &gt;&amp;2 <span class="comment">## standard error</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">        ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">shift</span> <span class="string">"<span class="variable">$(($OPTIND - 1)</span>)"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> <span class="string">"delimiter has been set to [<span class="variable">$IFS</span>]"</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">"<span class="variable">$IFS</span>"</span> | hexdump -C</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> <span class="variable">$@</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -f <span class="string">"<span class="variable">$item</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"file <span class="variable">$&#123;item&#125;</span> not exists"</span></span><br><span class="line">        <span class="built_in">continue</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> <span class="string">"file name: <span class="variable">$item</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># array contasing all line per file</span></span><br><span class="line">    line_arr=()</span><br><span class="line">    col_count=0</span><br><span class="line">    row_count=0</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span></span><br><span class="line">        line_arr[<span class="variable">$row_count</span>]=<span class="variable">$line</span></span><br><span class="line">        arr=(<span class="variable">$line</span>)</span><br><span class="line">        temp_count=<span class="variable">$&#123;#arr[@]&#125;</span></span><br><span class="line">        <span class="keyword">if</span> ((temp_count &gt; col_count)); <span class="keyword">then</span></span><br><span class="line">            col_count=<span class="variable">$temp_count</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        ((row_count++))</span><br><span class="line">    <span class="keyword">done</span> &lt;<span class="variable">$item</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">"table column size: <span class="variable">$&#123;col_count&#125;</span>, row size: <span class="variable">$&#123;row_count&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># array contains max length of every col</span></span><br><span class="line">    max_count_arr=()</span><br><span class="line">    <span class="keyword">for</span> ((i = 0; i &lt; <span class="variable">$&#123;row_count&#125;</span>; i++)); <span class="keyword">do</span></span><br><span class="line">        line=<span class="variable">$&#123;line_arr[i]&#125;</span></span><br><span class="line">        arr=(<span class="variable">$line</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 并行没有办法返回给一个变量，所以只能都写到文件中，然后再拼接</span></span><br><span class="line">        <span class="comment"># 此处还有一个方案就是行的并行，当前的方案是列的并行</span></span><br><span class="line">        files=<span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span>((l=0;l&lt;<span class="variable">$col_count</span>;l++)); <span class="keyword">do</span></span><br><span class="line">            (calLength <span class="string">"<span class="variable">$line</span>"</span> <span class="string">"<span class="variable">$l</span>"</span> <span class="string">"<span class="variable">$((l+1)</span>)"</span>) &amp;</span><br><span class="line">            files=<span class="string">"<span class="variable">$&#123;files&#125;</span>col<span class="variable">$&#123;l&#125;</span>.txt "</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="built_in">wait</span></span><br><span class="line"></span><br><span class="line">        result=$(<span class="built_in">echo</span> <span class="variable">$files</span> | xargs cat)</span><br><span class="line">        <span class="comment"># echo "command result: $result"</span></span><br><span class="line">        col_length_arr=(<span class="variable">$result</span>)</span><br><span class="line">        <span class="keyword">for</span> ((j = 0; j &lt; <span class="variable">$col_count</span>; j++)); <span class="keyword">do</span></span><br><span class="line">            max_length=<span class="variable">$&#123;max_count_arr[j]&#125;</span></span><br><span class="line">            current_length=<span class="variable">$&#123;col_length_arr[j]&#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((current_length &gt; max_length)); <span class="keyword">then</span></span><br><span class="line">                max_count_arr[j]=<span class="variable">$current_length</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$files</span> | xargs rm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># log "max width of every col: $&#123;max_count_arr[@]&#125;\n"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># for ((i = 0; i &lt; $&#123;row_count&#125;; i++)); do</span></span><br><span class="line">    i=0</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span></span><br><span class="line">        <span class="comment"># line=$&#123;line_arr[i]&#125;</span></span><br><span class="line">        arr=(<span class="variable">$line</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># echo "line:######### $line"</span></span><br><span class="line">        <span class="keyword">if</span> [[ <span class="variable">$isMD</span> -eq 1 &amp;&amp; <span class="variable">$i</span> -eq 1 ]]; <span class="keyword">then</span></span><br><span class="line">            printSymbolLie <span class="string">"|"</span> <span class="string">"-"</span> <span class="string">"<span class="variable">$&#123;max_count_arr[@]&#125;</span>"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># print the table head line +-------+-------+</span></span><br><span class="line">        <span class="keyword">if</span> [[ <span class="variable">$isMD</span> -eq 0 &amp;&amp; (<span class="variable">$i</span> -eq 0 || <span class="variable">$i</span> -eq 1) ]]; <span class="keyword">then</span></span><br><span class="line">            printSymbolLie <span class="string">"+"</span> <span class="string">"-"</span> <span class="string">"<span class="variable">$&#123;max_count_arr[@]&#125;</span>"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ((j = 0; j &lt; <span class="variable">$col_count</span>; j++)); <span class="keyword">do</span></span><br><span class="line">            bytes_chars=($(<span class="built_in">echo</span> -n <span class="variable">$&#123;arr[j]&#125;</span> | wc -c -m | xargs -n 1 <span class="built_in">echo</span> -n <span class="string">","</span>))</span><br><span class="line">            bytes=<span class="variable">$&#123;bytes_chars[2]&#125;</span></span><br><span class="line">            chars=<span class="variable">$&#123;bytes_chars[1]&#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># let's assume x: Chinese char count;  y:ascii char count; default charset is utf-8</span></span><br><span class="line">            <span class="comment"># as for display width: one Chinese character = ascii * 2</span></span><br><span class="line">            <span class="comment">#</span></span><br><span class="line">            <span class="comment"># (1) x*3 + y = bytes (use wc)</span></span><br><span class="line">            <span class="comment"># (2) x + y = chars (use wc)</span></span><br><span class="line">            <span class="comment"># (3) x*2 + y + z = max_width (we have calculated it before, z is the empty char count)</span></span><br><span class="line">            <span class="comment">#</span></span><br><span class="line">            <span class="comment"># printf command will count bytes as min size: printf "%-10s" "hello" 10 means bytes</span></span><br><span class="line">            <span class="comment"># so finally, the printf min size for current col is:</span></span><br><span class="line">            <span class="comment">#       3*x + y + z = max_col_width + (bytes - chars) / 2 (calculated by (1) (2) (3) above)</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((j == 0)); <span class="keyword">then</span> <span class="built_in">echo</span> -n <span class="string">"|"</span>; <span class="keyword">fi</span></span><br><span class="line">            max_col_width=<span class="variable">$&#123;max_count_arr[j]&#125;</span></span><br><span class="line">            min_print=$((max_col_width + (bytes - chars) / 2))</span><br><span class="line">            <span class="comment"># z=$((max_col_width - (bytes + chars) / 2))</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((i == 0 &amp;&amp; isColor == 1)); <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">printf</span> <span class="string">" \033[1;33m%-<span class="variable">$&#123;min_print&#125;</span>s\033[00m |"</span> <span class="variable">$&#123;arr[j]&#125;</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">printf</span> <span class="string">" %-<span class="variable">$&#123;min_print&#125;</span>s |"</span> <span class="variable">$&#123;arr[j]&#125;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span>  </span><br><span class="line">        <span class="built_in">echo</span></span><br><span class="line">        ((i++))</span><br><span class="line">    <span class="keyword">done</span> &lt;<span class="variable">$item</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print the end line +-------+-------+</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$isMD</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        printSymbolLie <span class="string">"+"</span> <span class="string">"-"</span> <span class="string">"<span class="variable">$&#123;max_count_arr[@]&#125;</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">IFS=<span class="variable">$oldIFS</span></span><br></pre></td></tr></table></figure>



<h3 id="列、行并行"><a href="#列、行并行" class="headerlink" title="列、行并行"></a>列、行并行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### rule: always use `LF` as the end of lie in linux or unexpected things will drive you crazy</span></span><br><span class="line"><span class="comment">### csv file to md table or normal table</span></span><br><span class="line"><span class="comment">### only ascii and chinese characters allowed in file,or it displays not properly and assumes utf-8 is used as charset</span></span><br><span class="line"></span><br><span class="line">oldIFS=<span class="variable">$IFS</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">log</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"[<span class="variable">$(date +"%F %T")</span>]: <span class="variable">$@</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">ExitFunc</span></span>() &#123;</span><br><span class="line">    IFS=<span class="variable">$oldIFS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">calLength</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> line=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">local</span> start=<span class="variable">$2</span></span><br><span class="line">    <span class="built_in">local</span> end=<span class="variable">$3</span></span><br><span class="line">    <span class="built_in">local</span> arr=(<span class="variable">$line</span>)</span><br><span class="line">    <span class="built_in">local</span> result=<span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((start &lt; end)); <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">local</span> col_str=<span class="variable">$&#123;arr[start]&#125;</span></span><br><span class="line">        <span class="comment"># wc output: always in the following order: newline, word, character, byte, maximum line length.</span></span><br><span class="line">        <span class="built_in">local</span> bytes_chars=($(<span class="built_in">echo</span> -n <span class="variable">$col_str</span> | wc -c -m | xargs -n 1 <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$IFS</span>"</span>))</span><br><span class="line">        <span class="built_in">local</span> bytes=<span class="variable">$&#123;bytes_chars[2]&#125;</span></span><br><span class="line">        <span class="built_in">local</span> chars=<span class="variable">$&#123;bytes_chars[1]&#125;</span></span><br><span class="line">        <span class="keyword">if</span> ((bytes &gt; chars)); <span class="keyword">then</span></span><br><span class="line">            result=<span class="string">"<span class="variable">$&#123;result&#125;</span><span class="variable">$(((bytes + chars)</span> / 2)),"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            result=<span class="string">"<span class="variable">$&#123;result&#125;</span><span class="variable">$chars</span>,"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        ((start++))</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$result</span>"</span> &gt;<span class="string">"col<span class="variable">$2</span>.txt"</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">calLength2</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> line=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">local</span> start=<span class="variable">$2</span></span><br><span class="line">    <span class="built_in">local</span> end=<span class="variable">$3</span></span><br><span class="line">    <span class="built_in">local</span> row=<span class="variable">$4</span></span><br><span class="line">    <span class="built_in">local</span> arr=(<span class="variable">$line</span>)</span><br><span class="line">    <span class="built_in">local</span> result=<span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((start &lt; end)); <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">local</span> col_str=<span class="variable">$&#123;arr[start]&#125;</span></span><br><span class="line">        <span class="comment"># wc output: always in the following order: newline, word, character, byte, maximum line length.</span></span><br><span class="line">        <span class="built_in">local</span> bytes_chars=($(<span class="built_in">echo</span> -n <span class="variable">$col_str</span> | wc -c -m | xargs -n 1 <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$IFS</span>"</span>))</span><br><span class="line">        <span class="built_in">local</span> bytes=<span class="variable">$&#123;bytes_chars[2]&#125;</span></span><br><span class="line">        <span class="built_in">local</span> chars=<span class="variable">$&#123;bytes_chars[1]&#125;</span></span><br><span class="line">        <span class="keyword">if</span> ((bytes &gt; chars)); <span class="keyword">then</span></span><br><span class="line">            result=<span class="string">"<span class="variable">$&#123;result&#125;</span><span class="variable">$(((bytes + chars)</span> / 2)),"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            result=<span class="string">"<span class="variable">$&#123;result&#125;</span><span class="variable">$chars</span>,"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        ((start++))</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$result</span>"</span> &gt;<span class="string">"row<span class="variable">$&#123;row&#125;</span>_col<span class="variable">$2</span>.txt"</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">rowCal</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> line_start_num=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">local</span> col_count=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">shift</span> 2</span><br><span class="line">    <span class="built_in">local</span> max_count_arr=()</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span>; <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">local</span> arr=(<span class="variable">$line</span>)</span><br><span class="line">        <span class="built_in">local</span> files=<span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> ((l = 0; l &lt; <span class="variable">$col_count</span>; l++)); <span class="keyword">do</span></span><br><span class="line">            (calLength2 <span class="string">"<span class="variable">$line</span>"</span> <span class="string">"<span class="variable">$l</span>"</span> <span class="string">"<span class="variable">$((l + 1)</span>)"</span> <span class="string">"<span class="variable">$&#123;line_start_num&#125;</span>"</span>) &amp;</span><br><span class="line">            files=<span class="string">"<span class="variable">$&#123;files&#125;</span>row<span class="variable">$&#123;line_start_num&#125;</span>_col<span class="variable">$&#123;l&#125;</span>.txt "</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="built_in">wait</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">local</span> result=$(<span class="built_in">echo</span> <span class="variable">$files</span> | xargs cat)</span><br><span class="line">        <span class="comment"># echo "command result: $result"</span></span><br><span class="line">        <span class="built_in">local</span> col_length_arr=(<span class="variable">$result</span>)</span><br><span class="line">        <span class="keyword">for</span> ((j = 0; j &lt; <span class="variable">$col_count</span>; j++)); <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">local</span> max_length=<span class="variable">$&#123;max_count_arr[j]&#125;</span></span><br><span class="line">            <span class="built_in">local</span> current_length=<span class="variable">$&#123;col_length_arr[j]&#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((current_length &gt; max_length)); <span class="keyword">then</span></span><br><span class="line">                max_count_arr[j]=<span class="variable">$current_length</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$files</span> | xargs rm &amp;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">local</span> final=<span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> count <span class="keyword">in</span> <span class="string">"<span class="variable">$&#123;max_count_arr[@]&#125;</span>"</span>; <span class="keyword">do</span></span><br><span class="line">        final=<span class="string">"<span class="variable">$&#123;final&#125;</span><span class="variable">$&#123;count&#125;</span>,"</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$final</span>"</span> &gt;<span class="string">"row<span class="variable">$&#123;line_start_num&#125;</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">printSymbolLie</span></span>() &#123;</span><br><span class="line">    sep=<span class="variable">$1</span></span><br><span class="line">    mid=<span class="variable">$2</span></span><br><span class="line">    <span class="built_in">shift</span> 2</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$sep</span>"</span></span><br><span class="line">    <span class="keyword">for</span> count <span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span>; <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">for</span> ((m = -2; m &lt; <span class="variable">$count</span>; m++)); <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$mid</span>"</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$sep</span>"</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">trap</span> <span class="string">'ExitFunc'</span> 2 9 15 20 EXIT</span><br><span class="line"></span><br><span class="line">isMD=0</span><br><span class="line">isColor=0</span><br><span class="line">IFS=,</span><br><span class="line">parrel=4</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">'cmp:d:'</span> OPT; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"<span class="variable">$OPT</span>"</span> <span class="keyword">in</span></span><br><span class="line">    c)</span><br><span class="line">        isColor=1</span><br><span class="line">        ;;</span><br><span class="line">    m)</span><br><span class="line">        isMD=1</span><br><span class="line">        ;;</span><br><span class="line">    p)</span><br><span class="line">        parrel=<span class="variable">$OPTARG</span></span><br><span class="line">        ;;</span><br><span class="line">    d)</span><br><span class="line">        IFS=$(<span class="built_in">echo</span> -ne <span class="string">"<span class="variable">$OPTARG</span>"</span>)</span><br><span class="line">        ;;</span><br><span class="line">    ?)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"avaliable options: [-c] [-m] [-d delimiter]"</span> &gt;&amp;2 <span class="comment">## standard error</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">        ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">shift</span> <span class="string">"<span class="variable">$(($OPTIND - 1)</span>)"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> <span class="string">"delimiter has been set to [<span class="variable">$IFS</span>]"</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">"<span class="variable">$IFS</span>"</span> | hexdump -C</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> <span class="variable">$@</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -f <span class="string">"<span class="variable">$item</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"file <span class="variable">$&#123;item&#125;</span> not exists"</span></span><br><span class="line">        <span class="built_in">continue</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> <span class="string">"file name: <span class="variable">$item</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">##########################################################</span></span><br><span class="line">    <span class="comment"># array contasing all line per file</span></span><br><span class="line">    line_arr=()</span><br><span class="line">    col_count=0</span><br><span class="line">    row_count=0</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span></span><br><span class="line">        line_arr[<span class="variable">$row_count</span>]=<span class="variable">$line</span></span><br><span class="line">        arr=(<span class="variable">$line</span>)</span><br><span class="line">        temp_count=<span class="variable">$&#123;#arr[@]&#125;</span></span><br><span class="line">        <span class="keyword">if</span> ((temp_count &gt; col_count)); <span class="keyword">then</span></span><br><span class="line">            col_count=<span class="variable">$temp_count</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        ((row_count++))</span><br><span class="line">    <span class="keyword">done</span> &lt;<span class="variable">$item</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">"table column size: <span class="variable">$&#123;col_count&#125;</span>, row size: <span class="variable">$&#123;row_count&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">##########################################################</span></span><br><span class="line">    row_files=<span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span> ((row_count &gt; parrel)); <span class="keyword">then</span></span><br><span class="line">        per_size=$((row_count / parrel))</span><br><span class="line">        <span class="keyword">for</span> ((r = 0; r &lt; <span class="variable">$parrel</span>; r++)); <span class="keyword">do</span></span><br><span class="line">            start_index=$((r * per_size))</span><br><span class="line">            <span class="keyword">if</span> ((r == parrel - 1)); <span class="keyword">then</span></span><br><span class="line">                length=$((row_count - (r*per_size)))</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                length=<span class="variable">$per_size</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            (rowCal <span class="string">"<span class="variable">$&#123;start_index&#125;</span>"</span> <span class="variable">$col_count</span> <span class="string">"<span class="variable">$&#123;line_arr[@]:$&#123;start_index&#125;</span>:<span class="variable">$&#123;length&#125;</span>&#125;"</span>) &amp;</span><br><span class="line">            row_files=<span class="string">"<span class="variable">$&#123;row_files&#125;</span>row<span class="variable">$&#123;start_index&#125;</span><span class="variable">$IFS</span>"</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        (rowCal 0 <span class="variable">$col_count</span> <span class="string">"<span class="variable">$&#123;line_arr[@]:0:$&#123;col_count&#125;</span>&#125;"</span>) &amp;</span><br><span class="line">        row_files=<span class="string">"row0"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">wait</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># array contains max length of every col</span></span><br><span class="line">    max_count_arr=()</span><br><span class="line">    <span class="keyword">for</span> row_cal_file <span class="keyword">in</span> <span class="variable">$row_files</span>; <span class="keyword">do</span></span><br><span class="line">        result=$(cat <span class="variable">$row_cal_file</span>)</span><br><span class="line">        col_length_arr=(<span class="variable">$result</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ((j = 0; j &lt; <span class="variable">$col_count</span>; j++)); <span class="keyword">do</span></span><br><span class="line">            max_length=<span class="variable">$&#123;max_count_arr[j]&#125;</span></span><br><span class="line">            current_length=<span class="variable">$&#123;col_length_arr[j]&#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((current_length &gt; max_length)); <span class="keyword">then</span></span><br><span class="line">                max_count_arr[j]=<span class="variable">$current_length</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        rm <span class="variable">$row_cal_file</span> &amp;</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">"max width of every col cal \n"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">##########################################################</span></span><br><span class="line">    <span class="comment"># for ((i = 0; i &lt; $&#123;row_count&#125;; i++)); do</span></span><br><span class="line">    i=0</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span></span><br><span class="line">        <span class="comment"># line=$&#123;line_arr[i]&#125;</span></span><br><span class="line">        arr=(<span class="variable">$line</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># echo "line:######### $line"</span></span><br><span class="line">        <span class="keyword">if</span> [[ <span class="variable">$isMD</span> -eq 1 &amp;&amp; <span class="variable">$i</span> -eq 1 ]]; <span class="keyword">then</span></span><br><span class="line">            printSymbolLie <span class="string">"|"</span> <span class="string">"-"</span> <span class="string">"<span class="variable">$&#123;max_count_arr[@]&#125;</span>"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># print the table head line +-------+-------+</span></span><br><span class="line">        <span class="keyword">if</span> [[ <span class="variable">$isMD</span> -eq 0 &amp;&amp; (<span class="variable">$i</span> -eq 0 || <span class="variable">$i</span> -eq 1) ]]; <span class="keyword">then</span></span><br><span class="line">            printSymbolLie <span class="string">"+"</span> <span class="string">"-"</span> <span class="string">"<span class="variable">$&#123;max_count_arr[@]&#125;</span>"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ((j = 0; j &lt; <span class="variable">$col_count</span>; j++)); <span class="keyword">do</span></span><br><span class="line">            bytes_chars=($(<span class="built_in">echo</span> -n <span class="variable">$&#123;arr[j]&#125;</span> | wc -c -m | xargs -n 1 <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$IFS</span>"</span>))</span><br><span class="line">            bytes=<span class="variable">$&#123;bytes_chars[2]&#125;</span></span><br><span class="line">            chars=<span class="variable">$&#123;bytes_chars[1]&#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># let's assume x: Chinese char count;  y:ascii char count; default charset is utf-8</span></span><br><span class="line">            <span class="comment"># as for display width: one Chinese character = ascii * 2</span></span><br><span class="line">            <span class="comment">#</span></span><br><span class="line">            <span class="comment"># (1) x*3 + y = bytes (use wc)</span></span><br><span class="line">            <span class="comment"># (2) x + y = chars (use wc)</span></span><br><span class="line">            <span class="comment"># (3) x*2 + y + z = max_width (we have calculated it before, z is the empty char count)</span></span><br><span class="line">            <span class="comment">#</span></span><br><span class="line">            <span class="comment"># printf command will count bytes as min size: printf "%-10s" "hello" 10 means bytes</span></span><br><span class="line">            <span class="comment"># so finally, the printf min size for current col is:</span></span><br><span class="line">            <span class="comment">#       3*x + y + z = max_col_width + (bytes - chars) / 2 (calculated by (1) (2) (3) above)</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((j == 0)); <span class="keyword">then</span> <span class="built_in">echo</span> -n <span class="string">"|"</span>; <span class="keyword">fi</span></span><br><span class="line">            max_col_width=<span class="variable">$&#123;max_count_arr[j]&#125;</span></span><br><span class="line">            min_print=$((max_col_width + (bytes - chars) / 2))</span><br><span class="line">            <span class="comment"># z=$((max_col_width - (bytes + chars) / 2))</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((i == 0 &amp;&amp; isColor == 1)); <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">printf</span> <span class="string">" \033[1;33m%-<span class="variable">$&#123;min_print&#125;</span>s\033[00m |"</span> <span class="variable">$&#123;arr[j]&#125;</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">printf</span> <span class="string">" %-<span class="variable">$&#123;min_print&#125;</span>s |"</span> <span class="variable">$&#123;arr[j]&#125;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">echo</span></span><br><span class="line">        ((i++))</span><br><span class="line">    <span class="keyword">done</span> &lt;<span class="variable">$item</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print the end line +-------+-------+</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$isMD</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        printSymbolLie <span class="string">"+"</span> <span class="string">"-"</span> <span class="string">"<span class="variable">$&#123;max_count_arr[@]&#125;</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">IFS=<span class="variable">$oldIFS</span></span><br></pre></td></tr></table></figure>





<h3 id="一次性输出"><a href="#一次性输出" class="headerlink" title="一次性输出"></a>一次性输出</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### rule: always use `LF` as the end of lie in linux or unexpected things will drive you crazy</span></span><br><span class="line"><span class="comment">### csv file to md table or normal table</span></span><br><span class="line"><span class="comment">### only ascii and chinese characters allowed in file,or it displays not properly and assumes utf-8 is used as charset</span></span><br><span class="line"></span><br><span class="line">oldIFS=<span class="variable">$IFS</span></span><br><span class="line">isVerbose=0</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">debug</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> ((isVerbose == 1)); <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">"[<span class="variable">$(date +"%F %T")</span>]: <span class="variable">$@</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">info</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">ExitFunc</span></span>() &#123;</span><br><span class="line">    IFS=<span class="variable">$oldIFS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">calLength2</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> line=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">local</span> start=<span class="variable">$2</span></span><br><span class="line">    <span class="built_in">local</span> end=<span class="variable">$3</span></span><br><span class="line">    <span class="built_in">local</span> row=<span class="variable">$4</span></span><br><span class="line">    <span class="built_in">local</span> arr=(<span class="variable">$line</span>)</span><br><span class="line">    <span class="built_in">local</span> result=<span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((start &lt; end)); <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">local</span> col_str=<span class="variable">$&#123;arr[start]&#125;</span></span><br><span class="line">        <span class="comment"># wc output: always in the following order: newline, word, character, byte, maximum line length.</span></span><br><span class="line">        <span class="built_in">local</span> bytes_chars=($(<span class="built_in">echo</span> -n <span class="variable">$col_str</span> | wc -c -m | xargs -n 1 <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$IFS</span>"</span>))</span><br><span class="line">        <span class="built_in">local</span> bytes=<span class="variable">$&#123;bytes_chars[2]&#125;</span></span><br><span class="line">        <span class="built_in">local</span> chars=<span class="variable">$&#123;bytes_chars[1]&#125;</span></span><br><span class="line">        <span class="keyword">if</span> ((bytes &gt; chars)); <span class="keyword">then</span></span><br><span class="line">            result=<span class="string">"<span class="variable">$&#123;result&#125;</span><span class="variable">$(((bytes + chars)</span> / 2)),"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            result=<span class="string">"<span class="variable">$&#123;result&#125;</span><span class="variable">$chars</span>,"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        ((start++))</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$result</span>"</span> &gt;<span class="string">"row<span class="variable">$&#123;row&#125;</span>_col<span class="variable">$2</span>.txt"</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">rowCal</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> line_start_num=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">local</span> col_count=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">shift</span> 2</span><br><span class="line">    <span class="built_in">local</span> max_count_arr=()</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span>; <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">        debug <span class="string">"line: <span class="variable">$line</span>"</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">local</span> arr=(<span class="variable">$line</span>)</span><br><span class="line">        <span class="built_in">local</span> files=<span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> ((l = 0; l &lt; <span class="variable">$col_count</span>; l++)); <span class="keyword">do</span></span><br><span class="line">            (calLength2 <span class="string">"<span class="variable">$line</span>"</span> <span class="string">"<span class="variable">$l</span>"</span> <span class="string">"<span class="variable">$((l + 1)</span>)"</span> <span class="string">"<span class="variable">$&#123;line_start_num&#125;</span>"</span>) &amp;</span><br><span class="line">            files=<span class="string">"<span class="variable">$&#123;files&#125;</span>row<span class="variable">$&#123;line_start_num&#125;</span>_col<span class="variable">$&#123;l&#125;</span>.txt "</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="built_in">wait</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">local</span> result=$(<span class="built_in">echo</span> <span class="variable">$files</span> | xargs cat)</span><br><span class="line">        <span class="comment"># echo "command result: $result"</span></span><br><span class="line">        <span class="built_in">local</span> col_length_arr=(<span class="variable">$result</span>)</span><br><span class="line">        <span class="keyword">for</span> ((j = 0; j &lt; <span class="variable">$col_count</span>; j++)); <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">local</span> max_length=<span class="variable">$&#123;max_count_arr[j]&#125;</span></span><br><span class="line">            <span class="built_in">local</span> current_length=<span class="variable">$&#123;col_length_arr[j]&#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((current_length &gt; max_length)); <span class="keyword">then</span></span><br><span class="line">                max_count_arr[j]=<span class="variable">$current_length</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$files</span> | xargs rm &amp;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">local</span> final=<span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> count <span class="keyword">in</span> <span class="string">"<span class="variable">$&#123;max_count_arr[@]&#125;</span>"</span>; <span class="keyword">do</span></span><br><span class="line">        final=<span class="string">"<span class="variable">$&#123;final&#125;</span><span class="variable">$&#123;count&#125;</span>,"</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$final</span>"</span> &gt;<span class="string">"row<span class="variable">$&#123;line_start_num&#125;</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">printSymbolLie</span></span>() &#123;</span><br><span class="line">    sep=<span class="variable">$1</span></span><br><span class="line">    mid=<span class="variable">$2</span></span><br><span class="line">    <span class="built_in">shift</span> 2</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$sep</span>"</span></span><br><span class="line">    <span class="keyword">for</span> count <span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span>; <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">for</span> ((m = -2; m &lt; <span class="variable">$count</span>; m++)); <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$mid</span>"</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$sep</span>"</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">trap</span> <span class="string">'ExitFunc'</span> 2 9 15 20 EXIT</span><br><span class="line"></span><br><span class="line">isMD=0</span><br><span class="line">isColor=0</span><br><span class="line">isParrel=0</span><br><span class="line">IFS=,</span><br><span class="line">parrel=4</span><br><span class="line"></span><br><span class="line">start_seconds=$(date +<span class="string">"%s"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">'cmvpn:d:'</span> OPT; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"<span class="variable">$OPT</span>"</span> <span class="keyword">in</span></span><br><span class="line">    c)</span><br><span class="line">        isColor=1</span><br><span class="line">        ;;</span><br><span class="line">    m)</span><br><span class="line">        isMD=1</span><br><span class="line">        ;;</span><br><span class="line">    p)</span><br><span class="line">        isParrel=1</span><br><span class="line">        ;;</span><br><span class="line">    v)</span><br><span class="line">        isVerbose=1</span><br><span class="line">        ;;</span><br><span class="line">    n)</span><br><span class="line">        parrel=<span class="variable">$OPTARG</span></span><br><span class="line">        ;;</span><br><span class="line">    d)</span><br><span class="line">        IFS=$(<span class="built_in">echo</span> -ne <span class="string">"<span class="variable">$OPTARG</span>"</span>)</span><br><span class="line">        ;;</span><br><span class="line">    ?)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"avaliable options: [-c] [-v] [-m] [-p] [-n parrel_size] [-d delimiter]"</span> &gt;&amp;2 <span class="comment">## standard error</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">        ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">shift</span> <span class="string">"<span class="variable">$(($OPTIND - 1)</span>)"</span></span><br><span class="line"></span><br><span class="line">debug <span class="string">"delimiter has been set to [<span class="variable">$IFS</span>]"</span></span><br><span class="line"><span class="keyword">if</span> ((isVerbose == 1)); <span class="keyword">then</span> <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$IFS</span>"</span> | hexdump -C; <span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> <span class="variable">$@</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -f <span class="string">"<span class="variable">$item</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"file <span class="variable">$&#123;item&#125;</span> not exists"</span></span><br><span class="line">        <span class="built_in">continue</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    debug <span class="string">"file name: <span class="variable">$item</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">##########################################################</span></span><br><span class="line">    <span class="comment"># array contasing all line per file</span></span><br><span class="line">    line_arr=()</span><br><span class="line">    col_count=0</span><br><span class="line">    row_count=0</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span></span><br><span class="line">        line_arr[<span class="variable">$row_count</span>]=<span class="variable">$line</span></span><br><span class="line">        arr=(<span class="variable">$line</span>)</span><br><span class="line">        temp_count=<span class="variable">$&#123;#arr[@]&#125;</span></span><br><span class="line">        <span class="keyword">if</span> ((temp_count &gt; col_count)); <span class="keyword">then</span></span><br><span class="line">            col_count=<span class="variable">$temp_count</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        ((row_count++))</span><br><span class="line">    <span class="keyword">done</span> &lt;<span class="variable">$item</span></span><br><span class="line">    debug <span class="string">"table column size: <span class="variable">$&#123;col_count&#125;</span>, row size: <span class="variable">$&#123;row_count&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">##########################################################</span></span><br><span class="line">    row_files=<span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span> ((isParrel == 1 &amp;&amp; row_count &gt; parrel)); <span class="keyword">then</span></span><br><span class="line">        per_size=$((row_count / parrel))</span><br><span class="line">        <span class="keyword">for</span> ((r = 0; r &lt; <span class="variable">$parrel</span>; r++)); <span class="keyword">do</span></span><br><span class="line">            start_index=$((r * per_size))</span><br><span class="line">            <span class="keyword">if</span> ((r == parrel - 1)); <span class="keyword">then</span></span><br><span class="line">                length=$((row_count - (r * per_size)))</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                length=<span class="variable">$per_size</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            (rowCal <span class="string">"<span class="variable">$&#123;start_index&#125;</span>"</span> <span class="variable">$col_count</span> <span class="string">"<span class="variable">$&#123;line_arr[@]:$&#123;start_index&#125;</span>:<span class="variable">$&#123;length&#125;</span>&#125;"</span>) &amp;</span><br><span class="line">            row_files=<span class="string">"<span class="variable">$&#123;row_files&#125;</span>row<span class="variable">$&#123;start_index&#125;</span><span class="variable">$IFS</span>"</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        debug <span class="string">"no parrel function call:"</span> 0 <span class="variable">$col_count</span> <span class="string">"<span class="variable">$&#123;line_arr[@]:0:$&#123;row_count&#125;</span>&#125;"</span></span><br><span class="line">        (rowCal 0 <span class="variable">$col_count</span> <span class="string">"<span class="variable">$&#123;line_arr[@]:0:$&#123;row_count&#125;</span>&#125;"</span>) &amp;</span><br><span class="line">        row_files=<span class="string">"row0"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">wait</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># array contains max length of every col</span></span><br><span class="line">    max_count_arr=()</span><br><span class="line">    <span class="keyword">for</span> row_cal_file <span class="keyword">in</span> <span class="variable">$row_files</span>; <span class="keyword">do</span></span><br><span class="line">        result=$(cat <span class="variable">$row_cal_file</span>)</span><br><span class="line">        col_length_arr=(<span class="variable">$result</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ((j = 0; j &lt; <span class="variable">$col_count</span>; j++)); <span class="keyword">do</span></span><br><span class="line">            max_length=<span class="variable">$&#123;max_count_arr[j]&#125;</span></span><br><span class="line">            current_length=<span class="variable">$&#123;col_length_arr[j]&#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((current_length &gt; max_length)); <span class="keyword">then</span></span><br><span class="line">                max_count_arr[j]=<span class="variable">$current_length</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        rm <span class="variable">$row_cal_file</span> &amp;</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    debug <span class="string">"max width of every col cal \n"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">##########################################################</span></span><br><span class="line">    <span class="comment"># for ((i = 0; i &lt; $&#123;row_count&#125;; i++)); do</span></span><br><span class="line">    i=0</span><br><span class="line"></span><br><span class="line">    format_str=<span class="string">""</span></span><br><span class="line">    parameter_str=<span class="string">""</span></span><br><span class="line">    print_count=0</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span></span><br><span class="line">        ((print_count++))</span><br><span class="line">        <span class="comment"># line=$&#123;line_arr[i]&#125;</span></span><br><span class="line">        arr=(<span class="variable">$line</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># echo "line:######### $line"</span></span><br><span class="line">        <span class="keyword">if</span> [[ <span class="variable">$isMD</span> -eq 1 &amp;&amp; <span class="variable">$i</span> -eq 1 ]]; <span class="keyword">then</span></span><br><span class="line">            format_str=<span class="variable">$&#123;format_str&#125;</span>$(printSymbolLie <span class="string">"|"</span> <span class="string">"-"</span> <span class="string">"<span class="variable">$&#123;max_count_arr[@]&#125;</span>"</span>)<span class="string">"\n"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># print the table head line +-------+-------+</span></span><br><span class="line">        <span class="keyword">if</span> [[ <span class="variable">$isMD</span> -eq 0 &amp;&amp; (<span class="variable">$i</span> -eq 0 || <span class="variable">$i</span> -eq 1) ]]; <span class="keyword">then</span></span><br><span class="line">            format_str=<span class="variable">$&#123;format_str&#125;</span>$(printSymbolLie <span class="string">"+"</span> <span class="string">"-"</span> <span class="string">"<span class="variable">$&#123;max_count_arr[@]&#125;</span>"</span>)<span class="string">"\n"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ((j = 0; j &lt; <span class="variable">$col_count</span>; j++)); <span class="keyword">do</span></span><br><span class="line">            bytes_chars=($(<span class="built_in">echo</span> -n <span class="variable">$&#123;arr[j]&#125;</span> | wc -c -m | xargs -n 1 <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$IFS</span>"</span>))</span><br><span class="line">            bytes=<span class="variable">$&#123;bytes_chars[2]&#125;</span></span><br><span class="line">            chars=<span class="variable">$&#123;bytes_chars[1]&#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># let's assume x: Chinese char count;  y:ascii char count; default charset is utf-8</span></span><br><span class="line">            <span class="comment"># as for display width: one Chinese character = ascii * 2</span></span><br><span class="line">            <span class="comment">#</span></span><br><span class="line">            <span class="comment"># (1) x*3 + y = bytes (use wc)</span></span><br><span class="line">            <span class="comment"># (2) x + y = chars (use wc)</span></span><br><span class="line">            <span class="comment"># (3) x*2 + y + z = max_width (we have calculated it before, z is the empty char count)</span></span><br><span class="line">            <span class="comment">#</span></span><br><span class="line">            <span class="comment"># printf command will count bytes as min size: printf "%-10s" "hello" 10 means bytes</span></span><br><span class="line">            <span class="comment"># so finally, the printf min size for current col is:</span></span><br><span class="line">            <span class="comment">#       3*x + y + z = max_col_width + (bytes - chars) / 2 (calculated by (1) (2) (3) above)</span></span><br><span class="line">            <span class="comment">#</span></span><br><span class="line">            <span class="comment"># todo:// optimization has to be done to reduce cal time</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((j == 0)); <span class="keyword">then</span> format_str=<span class="string">"<span class="variable">$&#123;format_str&#125;</span>|"</span>; <span class="keyword">fi</span></span><br><span class="line">            max_col_width=<span class="variable">$&#123;max_count_arr[j]&#125;</span></span><br><span class="line">            min_print=$((max_col_width + (bytes - chars) / 2))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((i == 0 &amp;&amp; isColor == 1)); <span class="keyword">then</span></span><br><span class="line">                format_str=<span class="string">"<span class="variable">$&#123;format_str&#125;</span> \033[1;33m%-<span class="variable">$&#123;min_print&#125;</span>s\033[00m |"</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                format_str=<span class="string">"<span class="variable">$&#123;format_str&#125;</span> %-<span class="variable">$&#123;min_print&#125;</span>s |"</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">            parameter_str=<span class="string">"<span class="variable">$&#123;parameter_str&#125;</span>\"<span class="variable">$&#123;arr[j]&#125;</span>\" "</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">        format_str=<span class="string">"<span class="variable">$&#123;format_str&#125;</span>\n"</span></span><br><span class="line"></span><br><span class="line">        debug <span class="string">"format_str: <span class="variable">$format_str</span>"</span></span><br><span class="line">        debug <span class="string">"parameter_str: <span class="variable">$parameter_str</span>"</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((print_count == 50 || print_count == row_count)); <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$parameter_str</span>"</span> | xargs <span class="built_in">printf</span> <span class="string">"<span class="variable">$format_str</span>"</span></span><br><span class="line">            parameter_str=<span class="string">""</span></span><br><span class="line">            format_str=<span class="string">""</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        ((i++))</span><br><span class="line">    <span class="keyword">done</span> &lt;<span class="variable">$item</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># echo -n "$parameter_str" | xargs printf "$format_str"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print the end line +-------+-------+</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$isMD</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        printSymbolLie <span class="string">"+"</span> <span class="string">"-"</span> <span class="string">"<span class="variable">$&#123;max_count_arr[@]&#125;</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">IFS=<span class="variable">$oldIFS</span></span><br><span class="line"></span><br><span class="line">end_seconds=$(date +<span class="string">"%s"</span>)</span><br><span class="line"></span><br><span class="line">info <span class="string">"\nTable row size: <span class="variable">$&#123;row_count&#125;</span>, column size: <span class="variable">$&#123;col_count&#125;</span>"</span></span><br><span class="line">info <span class="string">"It takes <span class="variable">$((end_seconds - start_seconds)</span>) seconds to calculate and display.\n"</span></span><br></pre></td></tr></table></figure>


                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/Linux/Man/">Man</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2020-06-21</span>
                
                <span class="post-category">
                    
                    <a class="category" href="/categories/Linux/">Linux</a>
                    
                </span>
                
            </div>
            <div class="post-content">
                
                    <h3 id="hexdump"><a href="#hexdump" class="headerlink" title="hexdump"></a>hexdump</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line">HEXDUMP(1)                                                                                            BSD General Commands Manual                                                                                           HEXDUMP(1)</span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">     hexdump, hd — ASCII, decimal, hexadecimal, octal dump</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">     hexdump [-bcCdovx] [-e format_string] [-f format_file] [-n length] [-s offset] file ...</span><br><span class="line">     hd [-bcdovx] [-e format_string] [-f format_file] [-n length] [-s offset] file ...</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">     The hexdump utility is a filter <span class="built_in">which</span> displays the specified files, or the standard input, <span class="keyword">if</span> no files are specified, <span class="keyword">in</span> a user specified format.</span><br><span class="line"></span><br><span class="line">     The options are as follows:</span><br><span class="line"></span><br><span class="line">     -b      One-byte octal display.  Display the input offset <span class="keyword">in</span> hexadecimal, followed by sixteen space-separated, three column, zero-filled, bytes of input data, <span class="keyword">in</span> octal, per line.</span><br><span class="line"></span><br><span class="line">     -c      One-byte character display.  Display the input offset <span class="keyword">in</span> hexadecimal, followed by sixteen space-separated, three column, space-filled, characters of input data per line.</span><br><span class="line"></span><br><span class="line">     -C      Canonical hex+ASCII display.  Display the input offset <span class="keyword">in</span> hexadecimal, followed by sixteen space-separated, two column, hexadecimal bytes, followed by the same sixteen bytes <span class="keyword">in</span> %_p format enclosed <span class="keyword">in</span> ``|<span class="string">''</span> characters.</span><br><span class="line"></span><br><span class="line">             Calling the <span class="built_in">command</span> hd implies this option.</span><br><span class="line"></span><br><span class="line">     -d      Two-byte decimal display.  Display the input offset <span class="keyword">in</span> hexadecimal, followed by eight space-separated, five column, zero-filled, two-byte units of input data, <span class="keyword">in</span> unsigned decimal, per line.</span><br><span class="line"></span><br><span class="line">     -e format_string</span><br><span class="line">             Specify a format string to be used <span class="keyword">for</span> displaying data.</span><br><span class="line"></span><br><span class="line">     -f format_file</span><br><span class="line">             Specify a file that contains one or more newline separated format strings.  Empty lines and lines whose first non-blank character is a <span class="built_in">hash</span> mark (<span class="comment">#) are ignored.</span></span><br><span class="line"></span><br><span class="line">     -n length</span><br><span class="line">             Interpret only length bytes of input.</span><br><span class="line"></span><br><span class="line">     -o      Two-byte octal display.  Display the input offset <span class="keyword">in</span> hexadecimal, followed by eight space-separated, six column, zero-filled, two byte quantities of input data, <span class="keyword">in</span> octal, per line.</span><br><span class="line"></span><br><span class="line">     -s offset</span><br><span class="line">             Skip offset bytes from the beginning of the input.  By default, offset is interpreted as a decimal number.  With a leading 0x or 0X, offset is interpreted as a hexadecimal number, otherwise, with a leading 0, offset</span><br><span class="line">             is interpreted as an octal number.  Appending the character b, k, or m to offset causes it to be interpreted as a multiple of 512, 1024, or 1048576, respectively.</span><br><span class="line"></span><br><span class="line">     -v      Cause hexdump to display all input data.  Without the -v option, any number of groups of output lines, <span class="built_in">which</span> would be identical to the immediately preceding group of output lines (except <span class="keyword">for</span> the input offsets), are</span><br><span class="line">             replaced with a line comprised of a single asterisk.</span><br><span class="line"></span><br><span class="line">     -x      Two-byte hexadecimal display.  Display the input offset <span class="keyword">in</span> hexadecimal, followed by eight, space separated, four column, zero-filled, two-byte quantities of input data, <span class="keyword">in</span> hexadecimal, per line.</span><br><span class="line"></span><br><span class="line">     For each input file, hexdump sequentially copies the input to standard output, transforming the data according to the format strings specified by the -e and -f options, <span class="keyword">in</span> the order that they were specified.</span><br><span class="line"></span><br><span class="line">   Formats</span><br><span class="line">     A format string contains any number of format units, separated by whitespace.  A format unit contains up to three items: an iteration count, a byte count, and a format.</span><br><span class="line"></span><br><span class="line">     The iteration count is an optional positive <span class="built_in">integer</span>, <span class="built_in">which</span> defaults to one.  Each format is applied iteration count <span class="built_in">times</span>.</span><br><span class="line"></span><br><span class="line">     The byte count is an optional positive <span class="built_in">integer</span>.  If specified it defines the number of bytes to be interpreted by each iteration of the format.</span><br><span class="line"></span><br><span class="line">     If an iteration count and/or a byte count is specified, a single slash must be placed after the iteration count and/or before the byte count to disambiguate them.  Any whitespace before or after the slash is ignored.</span><br><span class="line"></span><br><span class="line">     The format is required and must be surrounded by double quote (<span class="string">" "</span>) marks.  It is interpreted as a fprintf-style format string (see fprintf(3)), with the following exceptions:</span><br><span class="line"></span><br><span class="line">           ·   An asterisk (*) may not be used as a field width or precision.</span><br><span class="line"></span><br><span class="line">           ·   A byte count or field precision is required <span class="keyword">for</span> each ``s<span class="string">''</span> conversion character (unlike the fprintf(3) default <span class="built_in">which</span> prints the entire string <span class="keyword">if</span> the precision is unspecified).</span><br><span class="line"></span><br><span class="line">           ·   The conversion characters ``%<span class="string">''</span>, ``h<span class="string">''</span>, ``l<span class="string">''</span>, ``n<span class="string">''</span>, ``p<span class="string">''</span> and ``q<span class="string">''</span> are not supported.</span><br><span class="line"></span><br><span class="line">           ·   The single character escape sequences described <span class="keyword">in</span> the C standard are supported:</span><br><span class="line"></span><br><span class="line">                     NUL                  \0</span><br><span class="line">                     &lt;alert character&gt;    \a</span><br><span class="line">                     &lt;backspace&gt;          \b</span><br><span class="line">                     &lt;form-feed&gt;          \f</span><br><span class="line">                     &lt;newline&gt;            \n</span><br><span class="line">                     &lt;carriage <span class="built_in">return</span>&gt;    \r</span><br><span class="line">                     &lt;tab&gt;                \t</span><br><span class="line">                     &lt;vertical tab&gt;       \v</span><br><span class="line"></span><br><span class="line">     The hexdump utility also supports the following additional conversion strings:</span><br><span class="line"></span><br><span class="line">     _a[dox]     Display the input offset, cumulative across input files, of the next byte to be displayed.  The appended characters d, o, and x specify the display base as decimal, octal or hexadecimal respectively.</span><br><span class="line"></span><br><span class="line">     _A[dox]     Identical to the _a conversion string except that it is only performed once, when all of the input data has been processed.</span><br><span class="line"></span><br><span class="line">     _c          Output characters <span class="keyword">in</span> the default character <span class="built_in">set</span>.  Nonprinting characters are displayed <span class="keyword">in</span> three character, zero-padded octal, except <span class="keyword">for</span> those representable by standard escape notation (see above), <span class="built_in">which</span> are dis‐</span><br><span class="line">                 played as two character strings.</span><br><span class="line"></span><br><span class="line">     _p          Output characters <span class="keyword">in</span> the default character <span class="built_in">set</span>.  Nonprinting characters are displayed as a single “.”.</span><br><span class="line"></span><br><span class="line">     _u          Output US ASCII characters, with the exception that control characters are displayed using the following, lower-case, names.  Characters greater than 0xff, hexadecimal, are displayed as hexadecimal strings.</span><br><span class="line"></span><br><span class="line">                 000 NUL  001 SOH  002 STX  003 ETX  004 EOT  005 ENQ</span><br><span class="line">                 006 ACK  007 BEL  008 BS   009 HT   00A LF   00B VT</span><br><span class="line">                 00C FF   00D CR   00E SO   00F SI   010 DLE  011 DC1</span><br><span class="line">                 012 DC2  013 DC3  014 DC4  015 NAK  016 SYN  017 ETB</span><br><span class="line">                 018 CAN  019 EM   01A SUB  01B ESC  01C FS   01D GS</span><br><span class="line">                 01E RS   01F US   07F DEL</span><br><span class="line"></span><br><span class="line">     The default and supported byte counts <span class="keyword">for</span> the conversion characters are as follows:</span><br><span class="line"></span><br><span class="line">           %_c, %_p, %_u, %c       One byte counts only.</span><br><span class="line"></span><br><span class="line">           %d, %i, %o, %u, %X, %x  Four byte default, one, two and four byte counts supported.</span><br><span class="line"></span><br><span class="line">           %E, %e, %f, %G, %g      Eight byte default, four and twelve byte counts supported.</span><br><span class="line"></span><br><span class="line">     The amount of data interpreted by each format string is the sum of the data required by each format unit, <span class="built_in">which</span> is the iteration count <span class="built_in">times</span> the byte count, or the iteration count <span class="built_in">times</span> the number of bytes required by the</span><br><span class="line">     format <span class="keyword">if</span> the byte count is not specified.</span><br><span class="line"></span><br><span class="line">     The input is manipulated <span class="keyword">in</span> ``blocks<span class="string">''</span>, <span class="built_in">where</span> a block is defined as the largest amount of data specified by any format string.  Format strings interpreting less than an input block<span class="string">'s worth of data, whose last format unit both interprets some number of bytes and does not have a specified iteration count, have the iteration count incremented until the entire input block has been processed or there is not enough data remaining in the block to satisfy the format string.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     If, either as a result of user specification or hexdump modifying the iteration count as described above, an iteration count is greater than one, no trailing whitespace characters are output during the last iteration.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     It is an error to specify a byte count as well as multiple conversion characters or strings unless all but one of the conversion characters or strings is _a or _A.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     If, as a result of the specification of the -n option or end-of-file being reached, input data only partially satisfies a format string, the input block is zero-padded sufficiently to display all available data (i.e., any</span></span><br><span class="line"><span class="string">     format units overlapping the end of data will display some number of the zero bytes).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     Further output by such format strings is replaced by an equivalent number of spaces.  An equivalent number of spaces is defined as the number of spaces output by an s conversion character with the same field width and preci‐</span></span><br><span class="line"><span class="string">     sion as the original conversion character or conversion string but with any “+”, “ ”, “#” conversion flag characters removed, and referencing a NULL string.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     If no format strings are specified, the default display is equivalent to specifying the -x option.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EXIT STATUS</span></span><br><span class="line"><span class="string">     The hexdump and hd utilities exit 0 on success, and &gt;0 if an error occurs.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EXAMPLES</span></span><br><span class="line"><span class="string">     Display the input in perusal format:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">           "%06.6_ao "  12/1 "%3_u "</span></span><br><span class="line"><span class="string">           "\t\t" "%_p "</span></span><br><span class="line"><span class="string">           "\n"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     Implement the -x option:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">           "%07.7_Ax\n"</span></span><br><span class="line"><span class="string">           "%07.7_ax  " 8/2 "%04x " "\n"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     Some examples for the -e option:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">           # hex bytes</span></span><br><span class="line"><span class="string">           % echo hello | hexdump -v -e '</span>/1 <span class="string">"%02X "</span><span class="string">' ; echo</span></span><br><span class="line"><span class="string">           68 65 6C 6C 6F 0A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">           # same, with ASCII section</span></span><br><span class="line"><span class="string">           % echo hello | hexdump -e '</span>8/1 <span class="string">"%02X "</span><span class="string">"\t"</span><span class="string">" "</span><span class="string">' -e '</span>8/1 <span class="string">"%c"</span><span class="string">"\n"</span><span class="string">'</span></span><br><span class="line"><span class="string">           68 65 6C 6C 6F 0A        hello</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">           # hex with preceding '</span>x<span class="string">'</span></span><br><span class="line"><span class="string">           % echo hello | hexdump -v -e '</span><span class="string">"x"</span> 1/1 <span class="string">"%02X"</span> <span class="string">" "</span><span class="string">' ; echo</span></span><br><span class="line"><span class="string">           x68 x65 x6C x6C x6F x0A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">           # one hex byte per line</span></span><br><span class="line"><span class="string">           % echo hello | hexdump -v -e '</span>/1 <span class="string">"%02X\n"</span><span class="string">'</span></span><br><span class="line"><span class="string">           68</span></span><br><span class="line"><span class="string">           65</span></span><br><span class="line"><span class="string">           6C</span></span><br><span class="line"><span class="string">           6C</span></span><br><span class="line"><span class="string">           6F</span></span><br><span class="line"><span class="string">           0A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">           # a table of byte#, hex, decimal, octal, ASCII</span></span><br><span class="line"><span class="string">           % echo hello | hexdump -v  -e '</span>/1  <span class="string">"%_ad#    "</span><span class="string">' -e '</span>/1    <span class="string">"%02X hex"</span><span class="string">' -e '</span>/1 <span class="string">" = %03i dec"</span><span class="string">' -e '</span>/1 <span class="string">" = %03o oct"</span><span class="string">' -e '</span>/1 <span class="string">" = _%c\_\n"</span><span class="string">'</span></span><br><span class="line"><span class="string">           0#    68 hex = 104 dec = 150 oct = _h_</span></span><br><span class="line"><span class="string">           1#    65 hex = 101 dec = 145 oct = _e_</span></span><br><span class="line"><span class="string">           2#    6C hex = 108 dec = 154 oct = _l_</span></span><br><span class="line"><span class="string">           3#    6C hex = 108 dec = 154 oct = _l_</span></span><br><span class="line"><span class="string">           4#    6F hex = 111 dec = 157 oct = _o_</span></span><br><span class="line"><span class="string">           5#    0A hex = 010 dec = 012 oct = _</span></span><br><span class="line"><span class="string">           _</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">           # byte# &amp; ASCII with control chars</span></span><br><span class="line"><span class="string">           % echo hello | hexdump -v  -e '</span>/1  <span class="string">"%_ad#  "</span><span class="string">' -e '</span>/1 <span class="string">" _%_u\_\n"</span><span class="string">'</span></span><br><span class="line"><span class="string">           0#   _h_</span></span><br><span class="line"><span class="string">           1#   _e_</span></span><br><span class="line"><span class="string">           2#   _l_</span></span><br><span class="line"><span class="string">           3#   _l_</span></span><br><span class="line"><span class="string">           4#   _o_</span></span><br><span class="line"><span class="string">           5#   _lf_</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">SEE ALSO</span></span><br><span class="line"><span class="string">     gdb(1), od(1)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">BSD                                                                                                        October 29, 2014                                                                                                        BSD</span></span><br></pre></td></tr></table></figure>


                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/Linux/ls%20Invalid%20option/">ls Invalid option</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2020-06-14</span>
                
                <span class="post-category">
                    
                    <a class="category" href="/categories/Linux/">Linux</a>
                    
                </span>
                
            </div>
            <div class="post-content">
                
                    <h2 id="ls-invalid-option-–-‘j’"><a href="#ls-invalid-option-–-‘j’" class="headerlink" title="ls: invalid option – ‘j’"></a>ls: invalid option – ‘j’</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ls</span><br><span class="line"></span><br><span class="line">0n5whdeZ0ow-download.jpg  A-McbCSin6w-download.jpg  G1vKK6L7Ep0-download.jpg .....</span><br><span class="line">-jGGcAqIBms-download.jpg  -pahtnAMuFo-download.jpg </span><br><span class="line"></span><br><span class="line">$ ls *.jpg</span><br><span class="line">ls: invalid option -- <span class="string">'j'</span></span><br><span class="line">Try <span class="string">'ls --help'</span> <span class="keyword">for</span> more information.</span><br></pre></td></tr></table></figure>

<p>这个简单的命令执行失败了，期望 shell 扩展 <code>*</code> 找出所有 jpg 图像，也没有传入 <code>-j</code> 作为 option 选项，很是奇怪，通过 bing 找到了答案，百度真的是不适合程序员…..</p>
<p>StackExchange <a href="https://superuser.com/questions/1300382/ls-pdf-complains-ls-invalid-option" target="_blank" rel="noopener">ls invalid option</a> 中的问题类似，原因是有个图像文件开头是 <code>-</code> （-jGGcAqIBms-download.jpg），被当作 ls 的 option 选项了….</p>
<p>man bash</p>
<blockquote>
<p>A <code>--</code> signals the end of options and disables further option processing. Any arguments after the – are treated as file‐ names and arguments. An argument of - is equivalent to –.</p>
</blockquote>
<p>解决上述问题的办法：</p>
<ol>
<li>使用 <code>--</code> </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls -- *.jpg</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生产脚本使用 find + xargs，更保险</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -name选项指定了待查找文件名的模式。这个模式可以是通配符，也可以是正则表达式</span></span><br><span class="line">find . -<span class="built_in">type</span> f -name <span class="string">'*.jpg'</span> -print0 | xargs -0 -n 1 <span class="built_in">command</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>修改文件名，避免此种情况发生</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> img <span class="keyword">in</span> $(find . -maxdepth 1 -<span class="built_in">type</span> f  ! -iname <span class="string">'unsplash*.jpg'</span>); <span class="keyword">do</span> new=unsplash_<span class="variable">$&#123;img##*/&#125;</span>; sudo mv <span class="string">"<span class="variable">$img</span>"</span> <span class="string">"<span class="variable">$new</span>"</span>; <span class="keyword">done</span>;</span><br></pre></td></tr></table></figure>


                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/Linux/%E5%AE%89%E8%A3%85MacOS/">安装MacOS</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2020-06-13</span>
                
                <span class="post-category">
                    
                    <a class="category" href="/categories/Linux/">Linux</a>
                    
                </span>
                
            </div>
            <div class="post-content">
                
                    <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># （此命令用来设置禁用 hyper-v)</span></span><br><span class="line">bcdedit /<span class="built_in">set</span> hypervisorlaunchtype off </span><br><span class="line"></span><br><span class="line"><span class="comment">#【 如果想再次启用 hyper-v 的话，请运行此命令。】</span></span><br><span class="line">bcdedit /<span class="built_in">set</span> hypervisorlaunchtype auto</span><br></pre></td></tr></table></figure>

<p><a href="https://jingyan.baidu.com/article/215817f7e68fb81eda14230f.html" target="_blank" rel="noopener">Win 8/8.1 下virtualbox无法开启虚拟化解决方法</a></p>
<p>Push-button installer of macOS on VirtualBox <a href="https://github.com/myspaghetti/macos-virtualbox" target="_blank" rel="noopener"> macos-virtualbox</a></p>

                
            </div>
        </article>
    
        <article class="post-abstract">
            <div class="post-title">
                <h2><a class="post-title-link" href="/Mysql/%E8%BF%9E%E6%8E%A5/">连接</a></h2>
            </div>
            <div class="post-meta">
                <span class="post-time">2020-06-07</span>
                
                <span class="post-category">
                    
                    <a class="category" href="/categories/Mysql/">Mysql</a>
                    
                </span>
                
            </div>
            <div class="post-content">
                
                    <h2 id="问题还原"><a href="#问题还原" class="headerlink" title="问题还原"></a>问题还原</h2><p>表结构及索引情况</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; desc user_info</span><br><span class="line"></span><br><span class="line">Field	Type	Null	Key	Default	Extra</span><br><span class="line">id	int(11)	NO	PRI	\N	auto_increment</span><br><span class="line">uid	varchar(64)	NO	MUL	\N	</span><br><span class="line">name	varchar(255)	YES		\N	</span><br><span class="line"></span><br><span class="line">&gt; desc user_scode </span><br><span class="line">Field	Type	Null	Key	Default	Extra</span><br><span class="line">id	int(11)	NO	PRI	\N	auto_increment</span><br><span class="line">uid	varchar(64)	NO	MUL	\N	</span><br><span class="line">score	float	YES		\N</span><br></pre></td></tr></table></figure>

<p>表的大小和 user_score 表的数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span>  user_info</span><br><span class="line"> <span class="comment">-- 22000000</span></span><br><span class="line"> </span><br><span class="line"> <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span>  user_score </span><br><span class="line"> <span class="comment">-- 6</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">id</span>	uid			score</span><br><span class="line"><span class="number">9</span>	<span class="number">899</span><span class="number">-99</span><span class="number">-9905</span>	<span class="number">1.1</span></span><br><span class="line"><span class="number">10</span>	<span class="number">899</span><span class="number">-99</span><span class="number">-9905</span>	<span class="number">1.1</span></span><br><span class="line"><span class="number">11</span>	<span class="number">899</span><span class="number">-99</span><span class="number">-9905</span>	<span class="number">1.1</span></span><br><span class="line"><span class="number">12</span>	<span class="number">899</span><span class="number">-99</span><span class="number">-9905</span>	<span class="number">1.1</span></span><br><span class="line"><span class="number">13</span>	<span class="number">899</span><span class="number">-99</span><span class="number">-9904</span>	<span class="number">1.23</span></span><br><span class="line"><span class="number">14</span>	<span class="number">899</span><span class="number">-99</span><span class="number">-9904</span>	<span class="number">1.254</span></span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> user_score us <span class="keyword">join</span> user_info ui  <span class="keyword">on</span> us.uid = ui.uid <span class="keyword">where</span> us.id = <span class="number">13</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">id	uid	score	id	uid	name</span><br><span class="line">13	899-99-9904	1.23	20419033	899-99-9904	Julissa Rolfson</span><br><span class="line"></span><br><span class="line">1 row retrieved starting from 1 in 9 s 63 ms (execution: 9 s 31 ms, fetching: 32 ms)</span><br></pre></td></tr></table></figure>



<p>执行计划</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra</span><br><span class="line">1	SIMPLE	us	\N	const	PRIMARY,index_uid	PRIMARY	4	const	1	100	\N</span><br><span class="line">1	SIMPLE	ui	\N	ALL	\N	\N	\N	\N	21614208	100	Using where</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> user_info;</span><br><span class="line"></span><br><span class="line">Table	<span class="keyword">Create</span> <span class="keyword">Table</span></span><br><span class="line">user_info	<span class="string">"CREATE TABLE `user_info` (</span></span><br><span class="line"><span class="string">  `id` int(11) NOT NULL AUTO_INCREMENT,</span></span><br><span class="line"><span class="string">  `uid` varchar(64) NOT NULL,</span></span><br><span class="line"><span class="string">  `name` varchar(255) DEFAULT NULL,</span></span><br><span class="line"><span class="string">  PRIMARY KEY (`id`),</span></span><br><span class="line"><span class="string">  KEY `index_uid` (`uid`) USING BTREE</span></span><br><span class="line"><span class="string">) ENGINE=InnoDB AUTO_INCREMENT=22000001 DEFAULT CHARSET=utf8"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> user_score;</span><br><span class="line">Table	<span class="keyword">Create</span> <span class="keyword">Table</span></span><br><span class="line">user_score	<span class="string">"CREATE TABLE `user_score` (</span></span><br><span class="line"><span class="string">  `id` int(11) NOT NULL AUTO_INCREMENT,</span></span><br><span class="line"><span class="string">  `uid` varchar(64) NOT NULL,</span></span><br><span class="line"><span class="string">  `score` float DEFAULT NULL,</span></span><br><span class="line"><span class="string">  PRIMARY KEY (`id`),</span></span><br><span class="line"><span class="string">  KEY `index_uid` (`uid`)</span></span><br><span class="line"><span class="string">) ENGINE=InnoDB AUTO_INCREMENT=15 DEFAULT CHARSET=utf8mb4"</span></span><br></pre></td></tr></table></figure>



<p><img src="C:%5CUsers%5Cguo%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200510120118147.png" alt="image-20200510120118147"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* select#1 */</span> <span class="keyword">select</span> <span class="string">'13'</span> <span class="keyword">AS</span> <span class="string">`id`</span>,<span class="string">'899-99-9904'</span> <span class="keyword">AS</span> <span class="string">`uid`</span>,<span class="string">'1.23'</span> <span class="keyword">AS</span> <span class="string">`score`</span>,<span class="string">`learning_db`</span>.<span class="string">`ui`</span>.<span class="string">`id`</span> <span class="keyword">AS</span> <span class="string">`id`</span>,<span class="string">`learning_db`</span>.<span class="string">`ui`</span>.<span class="string">`uid`</span> <span class="keyword">AS</span> <span class="string">`uid`</span>,<span class="string">`learning_db`</span>.<span class="string">`ui`</span>.<span class="string">`name`</span> <span class="keyword">AS</span> <span class="string">`name`</span> <span class="keyword">from</span> <span class="string">`learning_db`</span>.<span class="string">`user_score`</span> <span class="string">`us`</span> <span class="keyword">join</span> <span class="string">`learning_db`</span>.<span class="string">`user_info`</span> <span class="string">`ui`</span> <span class="keyword">where</span> ((<span class="string">'899-99-9904'</span> = <span class="keyword">convert</span>(<span class="string">`learning_db`</span>.<span class="string">`ui`</span>.<span class="string">`uid`</span> <span class="keyword">using</span> utf8mb4)))</span><br></pre></td></tr></table></figure>



<p>字符集不一致的问题导致索引失效.</p>
<p>修改字符集：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> user_score <span class="keyword">CONVERT</span> <span class="keyword">TO</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8;</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> user_score us <span class="keyword">join</span> user_info ui  <span class="keyword">on</span> us.uid = ui.uid <span class="keyword">where</span> us.id = <span class="number">13</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">id</span>	uid	score	<span class="keyword">id</span>	uid	<span class="keyword">name</span></span><br><span class="line"><span class="number">13</span>	<span class="number">899</span><span class="number">-99</span><span class="number">-9904</span>	<span class="number">1.23</span>	<span class="number">20419033</span>	<span class="number">899</span><span class="number">-99</span><span class="number">-9904</span>	Julissa Rolfson</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> retrieved <span class="keyword">starting</span> <span class="keyword">from</span> <span class="number">1</span> <span class="keyword">in</span> <span class="number">47</span> ms (execution: <span class="number">0</span> ms, fetching: <span class="number">47</span> ms)</span><br></pre></td></tr></table></figure>



<p>执行计划：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra</span><br><span class="line">1	SIMPLE	us	\N	const	PRIMARY,index_uid	PRIMARY	4	const	1	100	\N</span><br><span class="line">1	SIMPLE	ui	\N	ref	index_uid	index_uid	194	const	1	100	\N</span><br></pre></td></tr></table></figure>



<ol>
<li>如果存在 JOIN 连接等操作的表，在建表的时候就应该留心之前系统的规范是什么，建表的默认字符集或者规定的字符集是什么， 而不应该依靠于自己的喜好和认知去建立</li>
<li>索引列参加计算会导致索引失效，所以非索引常量等值条件的查询，或者较复杂涉及连接的查询，都应该提前分析是否会使用索引，语句的效率，测试执行时间，查看执行计划，看看是否符合预期</li>
</ol>
<p>原文地址： <a href="https://mp.weixin.qq.com/s/Cimeyo4cVQsF-MfHBsNgGg?1=a" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/Cimeyo4cVQsF-MfHBsNgGg?1=a</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain select * from  user_info ui straight_join user_score us  on ui.uid &#x3D; us.uid  where us.id &#x3D; 13</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[HY000][1003] <span class="comment">/* select#1 */</span> <span class="keyword">select</span> <span class="string">`learning_db`</span>.<span class="string">`ui`</span>.<span class="string">`id`</span> <span class="keyword">AS</span> <span class="string">`id`</span>,<span class="string">`learning_db`</span>.<span class="string">`ui`</span>.<span class="string">`uid`</span> <span class="keyword">AS</span> <span class="string">`uid`</span>,<span class="string">`learning_db`</span>.<span class="string">`ui`</span>.<span class="string">`name`</span> <span class="keyword">AS</span> <span class="string">`name`</span>,<span class="string">`learning_db`</span>.<span class="string">`ui`</span>.<span class="string">`upd_time`</span> <span class="keyword">AS</span> <span class="string">`upd_time`</span>,<span class="string">`learning_db`</span>.<span class="string">`us`</span>.<span class="string">`id`</span> <span class="keyword">AS</span> <span class="string">`id`</span>,<span class="string">`learning_db`</span>.<span class="string">`us`</span>.<span class="string">`uid`</span> <span class="keyword">AS</span> <span class="string">`uid`</span>,<span class="string">`learning_db`</span>.<span class="string">`us`</span>.<span class="string">`score`</span> <span class="keyword">AS</span> <span class="string">`score`</span> <span class="keyword">from</span> <span class="string">`learning_db`</span>.<span class="string">`user_info`</span> <span class="string">`ui`</span> <span class="keyword">straight_join</span> <span class="string">`learning_db`</span>.<span class="string">`user_score`</span> <span class="string">`us`</span> <span class="keyword">where</span> ((<span class="string">`learning_db`</span>.<span class="string">`us`</span>.<span class="string">`id`</span> = <span class="number">13</span>) <span class="keyword">and</span> (<span class="string">`learning_db`</span>.<span class="string">`us`</span>.<span class="string">`uid`</span> = <span class="keyword">convert</span>(<span class="string">`learning_db`</span>.<span class="string">`ui`</span>.<span class="string">`uid`</span> <span class="keyword">using</span> utf8mb4)))</span><br></pre></td></tr></table></figure>





<p>在字符集编码相同的情况下，强制使得 <code>user_info</code> 表作为驱动表的情况：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span>  user_info ui <span class="keyword">straight_join</span> user_score us  <span class="keyword">on</span> ui.uid = us.uid  <span class="keyword">where</span> us.id = <span class="number">13</span>;</span><br><span class="line"></span><br><span class="line">id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra</span><br><span class="line">1	SIMPLE	ui	\N	ALL	index_uid	\N	\N	\N	21919807	100	\N</span><br><span class="line">1	SIMPLE	us	\N	const	PRIMARY,index_uid	PRIMARY	4	const	1	50	Using where</span><br></pre></td></tr></table></figure>







<h2 id="外连接"><a href="#外连接" class="headerlink" title="外连接"></a>外连接</h2><p>备注：使用的 Mysql版本为 5.7 ，参考的Mysql官方使用手册也是 5.7 的</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">version()</span>: <span class="string">5.7.29-0ubuntu0.18.04.1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Reference</span> <span class="string">Manual: MySQL 5.7 Reference Manual Including MySQL NDB Cluster 7.5 and NDB Cluster 7.6</span></span><br></pre></td></tr></table></figure>



<p>外连接 Outer Joins 包含 <code>LEFT JOIN</code> 和 <code>RIGHT JOIN</code></p>
<p>在外连接 <code>A LEFT JOIN B</code> 中将 B 表的筛选条件写在连接条件 （JOIN CONDITION, <code>on A.col = B.col</code>）和写在 WHERE 字句中的结果</p>
<p>此例中，<code>user_info_temp</code> 表中有一条 <code>uid</code> 为 <code>&#39;899-99-9905&#39;</code> 的行，<code>user_score_temp</code> 中有两条 uid 为 <code>&#39;899-99-9905&#39;</code> 的数据</p>
<h3 id="B-表的筛选条件写在连接条件中"><a href="#B-表的筛选条件写在连接条件中" class="headerlink" title="B 表的筛选条件写在连接条件中"></a>B 表的筛选条件写在连接条件中</h3><p><strong>sql 语句:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span>  user_info_temp ui <span class="keyword">left</span> <span class="keyword">join</span> user_score_temp us <span class="keyword">on</span> us.uid = ui.uid <span class="keyword">and</span> us.uid = <span class="string">'899-99-9905'</span>;</span><br></pre></td></tr></table></figure>

<p><strong>执行计划：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra</span><br><span class="line">1	SIMPLE	ui	\N	ALL	\N	\N	\N	\N	5	100	\N</span><br><span class="line">1	SIMPLE	us	\N	ref	index_uid	index_uid	194	const	2	100	Using where</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 这里应该使用了 Indexed Nested Loop Join 连接算法, 会使用 B 表中连接字段的索引</span></span><br></pre></td></tr></table></figure>

<p><strong>执行结果:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">id	uid	name	id	uid	score</span><br><span class="line">5042849	899-99-9926	Leif Streich V	\N	\N	\N</span><br><span class="line">8018366	899-99-9948	Hulda Rodriguez	\N	\N	\N</span><br><span class="line">20107227	899-99-9921	Sarita Kassulke IV	\N	\N	\N</span><br><span class="line">20419033	899-99-9905	Julissa Rolfson	12	899-99-9905	1.1</span><br><span class="line">20419033	899-99-9905	Julissa Rolfson	13	899-99-9905	1.23</span><br><span class="line">21439863	899-99-9926	Stuart Daugherty	\N	\N	\N</span><br></pre></td></tr></table></figure>



<h3 id="B-表的筛选条件写在-WHERE-字句中"><a href="#B-表的筛选条件写在-WHERE-字句中" class="headerlink" title="B 表的筛选条件写在 WHERE 字句中"></a>B 表的筛选条件写在 WHERE 字句中</h3><p><strong>sql 语句:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span>  user_info_temp ui <span class="keyword">left</span> <span class="keyword">join</span> user_score_temp us <span class="keyword">on</span> us.uid = ui.uid <span class="keyword">where</span> us.uid = <span class="string">'899-99-9905'</span>;</span><br></pre></td></tr></table></figure>

<p><strong>执行计划：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra</span><br><span class="line">1	SIMPLE	ui	\N	ref	index_uid	index_uid	194	const	1	100	\N</span><br><span class="line">1	SIMPLE	us	\N	ref	index_uid	index_uid	194	const	2	100	Using index condition</span><br></pre></td></tr></table></figure>

<p><strong>执行结果：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id	uid	name	id	uid	score</span><br><span class="line">20419033	899-99-9905	Julissa Rolfson	12	899-99-9905	1.1</span><br><span class="line">20419033	899-99-9905	Julissa Rolfson	13	899-99-9905	1.23</span><br></pre></td></tr></table></figure>



<h3 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h3><p>出现不同结果的原因是，写在连接条件中，会作为连接前筛选 B 表的条件，B 表中满足条件的有两条, 再做外连接; 而写在 WHERE 字句中，是作为连接后的结果的筛选条件的, 只筛选出结果中 B 表的列满足条件的结果.</p>
<p>Mysql 手册 - <strong>8.2.1.8 Outer Join Optimization</strong> 节中对外连接的步骤有如下描述：</p>
<blockquote>
<p>The LEFT JOIN condition is used to decide how to retrieve rows from table <em>B</em>. (In other words, any<br>condition in the WHERE clause is not used.)</p>
</blockquote>
<p>也就是说, 连接条件决定了如何从 B 表中进行检索数据, WHERE 子句中 B 的条件此时是不会使用的. </p>
<p>还需要注意一点的是,  B 表的筛选条件写在 WHERE 字句中, 此时, Mysql 应该是将其转换为一个 <code>INNER JOIN</code> 了,  执行计划中的两个步骤都是用的索引, 而且在控制台中对应打印出了如下的结果:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[HY000][1003] <span class="comment">/* select#1 */</span> <span class="keyword">select</span> <span class="string">`learning_db`</span>.<span class="string">`ui`</span>.<span class="string">`id`</span> <span class="keyword">AS</span> <span class="string">`id`</span>,<span class="string">`learning_db`</span>.<span class="string">`ui`</span>.<span class="string">`uid`</span> <span class="keyword">AS</span> <span class="string">`uid`</span>,<span class="string">`learning_db`</span>.<span class="string">`ui`</span>.<span class="string">`name`</span> <span class="keyword">AS</span> <span class="string">`name`</span>,<span class="string">`learning_db`</span>.<span class="string">`us`</span>.<span class="string">`id`</span> <span class="keyword">AS</span> <span class="string">`id`</span>,<span class="string">`learning_db`</span>.<span class="string">`us`</span>.<span class="string">`uid`</span> <span class="keyword">AS</span> <span class="string">`uid`</span>,<span class="string">`learning_db`</span>.<span class="string">`us`</span>.<span class="string">`score`</span> <span class="keyword">AS</span> <span class="string">`score`</span> <span class="keyword">from</span> <span class="string">`learning_db`</span>.<span class="string">`user_info_temp`</span> <span class="string">`ui`</span> <span class="keyword">join</span> <span class="string">`learning_db`</span>.<span class="string">`user_score_temp`</span> <span class="string">`us`</span> <span class="keyword">where</span> ((<span class="string">`learning_db`</span>.<span class="string">`us`</span>.<span class="string">`uid`</span> = <span class="string">`learning_db`</span>.<span class="string">`ui`</span>.<span class="string">`uid`</span>) <span class="keyword">and</span> (<span class="string">`learning_db`</span>.<span class="string">`ui`</span>.<span class="string">`uid`</span> = <span class="string">'899-99-9905'</span>))</span><br></pre></td></tr></table></figure>



<p>其中并没有出现 <code>left join</code> , 而是被转换成了 <code>join</code>,  大概想下, 这时的外连接其实是等价于内连接的, 如果 B 的常量等值条件要满足, B 表对应的那一行必然和 A 表中的某一行关联的上, 不能关联上, 则都为 <code>NULL</code> (前提是 B 的条件列声明为 <code>NOT NULL</code>),  所以是等价于内连接的.  </p>
<p><strong>因此, 在这种情况下, 写成内连接更能表达清楚本来的意图</strong>.</p>
<p>Mysql 手册 - <strong>8.2.1.8 Outer Join Optimization</strong> 中的相关描述:</p>
<blockquote>
<p>For a LEFT JOIN, if the WHERE condition is always false for the generated NULL row, the LEFT JOIN<br>is changed to an inner join. </p>
</blockquote>
<p>如果 t2.column 为 null， t2.column2=5 这个条件总是 false</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> t2 <span class="keyword">ON</span> (column1) <span class="keyword">WHERE</span> t2.column2=<span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<p>因此，可以安全的等价为一个内连接：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t1, t2 <span class="keyword">WHERE</span> t2.column2=<span class="number">5</span> <span class="keyword">AND</span> t1.column1=t2.column1;</span><br></pre></td></tr></table></figure>

<p>在进行转换后，查询优化器（optimizer）就可以根据情况，做出一个较优的查询计划，比如，使用 <code>t2</code> 作为驱动表</p>
<p><strong>不能进行转换的情况</strong></p>
<p>所以如果 B 的条件列可以是 <code>NULL</code> （没有声明为 <code>NOT NUll</code>）,  而且条件为 <code>B.col is NULL</code> , 这时, 就不能等价于内连接了, 因为满足 <code>B.col is NULL</code> 的情况有两种, 一种是本来就没有关联上,  另一种是关联上了, 这一列的值本来就是 <code>NULL</code>,  就不满足 <code>WHERE condition is always false for the generated NULL row</code></p>
<h3 id="外连接的简化"><a href="#外连接的简化" class="headerlink" title="外连接的简化"></a>外连接的简化</h3><ul>
<li>解析阶段，右连接会被转换为只包含左连接</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(T1, ...) RIGHT JOIN (T2, ...) ON P(T1, ..., T2, ...)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(T2, ...) LEFT JOIN (T1, ...) ON P(T1, ..., T2, ...)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> user_info_temp a <span class="keyword">right</span> <span class="keyword">join</span> user_score_temp b <span class="keyword">on</span> a.uid = b.uid;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show warnings;</span><br><span class="line"></span><br><span class="line">| Note  | 1003 | <span class="comment">/* select#1 */</span> <span class="keyword">select</span> <span class="string">`learning_db`</span>.<span class="string">`a`</span>.<span class="string">`id`</span> <span class="keyword">AS</span> <span class="string">`id`</span>,<span class="string">`learning_db`</span>.<span class="string">`a`</span>.<span class="string">`uid`</span> <span class="keyword">AS</span> <span class="string">`uid`</span>,<span class="string">`learning_db`</span>.<span class="string">`a`</span>.<span class="string">`name`</span> <span class="keyword">AS</span> <span class="string">`name`</span>,<span class="string">`learning_db`</span>.<span class="string">`b`</span>.<span class="string">`id`</span> <span class="keyword">AS</span> <span class="string">`id`</span>,<span class="string">`learning_db`</span>.<span class="string">`b`</span>.<span class="string">`uid`</span> <span class="keyword">AS</span> <span class="string">`uid`</span>,<span class="string">`learning_db`</span>.<span class="string">`b`</span>.<span class="string">`score`</span> <span class="keyword">AS</span> <span class="string">`score`</span> <span class="keyword">from</span> <span class="string">`learning_db`</span>.<span class="string">`user_score_temp`</span> <span class="string">`b`</span> <span class="keyword">left</span> <span class="keyword">join</span> <span class="string">`learning_db`</span>.<span class="string">`user_info_temp`</span> <span class="string">`a`</span> <span class="keyword">on</span>((<span class="string">`learning_db`</span>.<span class="string">`a`</span>.<span class="string">`uid`</span> = <span class="string">`learning_db`</span>.<span class="string">`b`</span>.<span class="string">`uid`</span>)) <span class="keyword">where</span> <span class="number">1</span> |</span><br></pre></td></tr></table></figure>

<ul>
<li>所有 <code>T1 INNER JOIN T2 ON P(T1, T2)</code> 形式的内连接表达式，会被替换成，<code>T1,T2</code>,  <code>P(T1, T2)</code> 会作为 <code>WHERE</code> 条件进行结合</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> user_info_temp a <span class="keyword">join</span> user_score_temp b <span class="keyword">on</span> a.uid = b.uid;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show warnings; </span><br><span class="line"></span><br><span class="line">| Note  | 1003 | <span class="comment">/* select#1 */</span> <span class="keyword">select</span> <span class="string">`learning_db`</span>.<span class="string">`a`</span>.<span class="string">`id`</span> <span class="keyword">AS</span> <span class="string">`id`</span>,<span class="string">`learning_db`</span>.<span class="string">`a`</span>.<span class="string">`uid`</span> <span class="keyword">AS</span> <span class="string">`uid`</span>,<span class="string">`learning_db`</span>.<span class="string">`a`</span>.<span class="string">`name`</span> <span class="keyword">AS</span> <span class="string">`name`</span>,<span class="string">`learning_db`</span>.<span class="string">`b`</span>.<span class="string">`id`</span> <span class="keyword">AS</span> <span class="string">`id`</span>,<span class="string">`learning_db`</span>.<span class="string">`b`</span>.<span class="string">`uid`</span> <span class="keyword">AS</span> <span class="string">`uid`</span>,<span class="string">`learning_db`</span>.<span class="string">`b`</span>.<span class="string">`score`</span> <span class="keyword">AS</span> <span class="string">`score`</span> <span class="keyword">from</span> <span class="string">`learning_db`</span>.<span class="string">`user_info_temp`</span> <span class="string">`a`</span> <span class="keyword">join</span> <span class="string">`learning_db`</span>.<span class="string">`user_score_temp`</span> <span class="string">`b`</span> <span class="keyword">where</span> (<span class="string">`learning_db`</span>.<span class="string">`b`</span>.<span class="string">`uid`</span> = <span class="string">`learning_db`</span>.<span class="string">`a`</span>.<span class="string">`uid`</span>) |</span><br></pre></td></tr></table></figure>

<ul>
<li>利用外连接的转换，获得更优的执行计划</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * T1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> T2 <span class="keyword">ON</span> P1(T1,T2)</span><br><span class="line"><span class="keyword">WHERE</span> P(T1,T2) <span class="keyword">AND</span> R(T2)</span><br></pre></td></tr></table></figure>

<p>  如果此时 <code>R(2)</code> 这个限制条件能够极大的减少 <code>T2</code> 表中匹配的行数，但是还时按照当前的执行顺序，先访问 <code>T1</code>,  再访问 <code>T2</code> 表，就可能会产生一个不够高效的执行计划</p>
<p>  如果此时，能够将这个外连接转换为内连接，可能会有一个更高效的执行计划。</p>
<p>  <strong>什么样的情况下，一个外连接可以被转换为一个内连接？</strong></p>
<blockquote>
<p>MySQL converts the query to a query with no outer join operation if the WHERE condition is null-rejected.</p>
<p>A condition is said to be null-rejected for an outer join operation if it evaluates to FALSE or UNKNOWN for any NULL-complemented row<br>generated for the operation.</p>
<p>如果对于外连接操作的补足NULL行（A LEFT JOIN B –&gt; B.COL IS ALL NULL), 这些条件总是 <code>FALSE</code> 或者 <code>UNKNOW</code> 的，这些条件就是 <code>null-rejected</code> 的</p>
</blockquote>
<p>  考虑这样一个简单的外连接：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">T1 LEFT JOIN T2 ON T1.A=T2.A</span><br><span class="line"></span><br><span class="line"><span class="comment">-- null-rejected conditions: false for `null` rows</span></span><br><span class="line">T2.B IS NOT NULL</span><br><span class="line">T2.B &gt; 3</span><br><span class="line">T2.C &lt;= T1.C</span><br><span class="line">T2.B &lt; 2 OR T2.C &gt; 1</span><br><span class="line"></span><br><span class="line"><span class="comment">-- not null-rejected conditions: mignt be true for `null` rows</span></span><br><span class="line">T2.B IS NULL</span><br><span class="line">T1.B &lt; 3 OR T2.B IS NOT NULL</span><br><span class="line">T1.B &lt; 3 OR T2.B &gt; 3</span><br></pre></td></tr></table></figure>

<p>  <strong>通用的检查规则</strong></p>
<ul>
<li><p><code>A IS NOT NULL</code> A 是左连接内表的一个属性</p>
</li>
<li><p>一个谓词(predicate)条件，其中包含了对左连接内表的引用，并且当这个谓词的某一个参数为 NULL 时，谓词返回的值为 <code>UNKNOWN</code></p>
<p>什么是谓词？谓词就是返回值为真值(<code>TRUE</code>, )的函数，如 <code>= &lt; &gt; &lt;&gt;</code>比较谓词，<code>LIKE</code>谓词，<code>BETWEEN</code> 谓词，<code>IS NULL, IS NOT NULL</code>, <code>IN</code>谓词，<code>EXISTS</code></p>
</li>
<li><p>AND 进行连接条件，包含了一个 null-rejected 的条件</p>
</li>
<li><p>OR 连接的条件，并且所有条件都是 null-rejected</p>
</li>
<li><p><em>示例*</em></p>
</li>
</ul>
<ol>
<li>简单转换</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- before converted</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> T1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> T2 <span class="keyword">ON</span> T2.A=T1.A</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> T3 <span class="keyword">ON</span> T3.B=T1.B</span><br><span class="line"><span class="keyword">WHERE</span> T3.C &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- after converted</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> T1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> T2 <span class="keyword">ON</span> T2.A=T1.A</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> T3 <span class="keyword">ON</span> T3.B=T1.B</span><br><span class="line"><span class="keyword">WHERE</span> T3.C &gt; <span class="number">0</span></span><br></pre></td></tr></table></figure>



<ol start="2">
<li>连续触发</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- before converted</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> T1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> T2 <span class="keyword">ON</span> T2.A=T1.A</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> T3 <span class="keyword">ON</span> T3.B=T2.B</span><br><span class="line"><span class="keyword">WHERE</span> T3.C &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- first convertion</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> T1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> T2 <span class="keyword">ON</span> T2.A=T1.A</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> T3 <span class="keyword">ON</span> T3.B=T2.B</span><br><span class="line"><span class="keyword">WHERE</span> T3.C &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- equivalent to the query</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (T1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> T2 <span class="keyword">ON</span> T2.A=T1.A), T3</span><br><span class="line"><span class="keyword">WHERE</span> T3.C &gt; <span class="number">0</span> <span class="keyword">AND</span> T3.B=T2.B</span><br><span class="line"></span><br><span class="line"><span class="comment">--second convertion: T3.B=T2.B is null-rejected for embeeded outer join</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (T1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> T2 <span class="keyword">ON</span> T2.A=T1.A), T3</span><br><span class="line"><span class="keyword">WHERE</span> T3.C &gt; <span class="number">0</span> <span class="keyword">AND</span> T3.B=T2.B</span><br></pre></td></tr></table></figure>




<h3 id="MySQL-Optimizer-查询优化器"><a href="#MySQL-Optimizer-查询优化器" class="headerlink" title="MySQL Optimizer 查询优化器"></a>MySQL Optimizer 查询优化器</h3><p><strong>会根据当前表的信息给出执行计划，所以类似的查询语句可能在不同的情况下执行计划不同：</strong></p>
<p>user_info 表和 user_score 两张表， user_info 表有 2200 百万数据，表 user_score 有 6 条数据，通过 uid 字段可以关联，且两张表的 uid 字段都设置了索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span>  user_info</span><br><span class="line"> <span class="comment">-- 22000000</span></span><br><span class="line"> </span><br><span class="line"> <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span>  user_score </span><br><span class="line"> <span class="comment">-- 6</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">id</span>	uid			score</span><br><span class="line"><span class="number">9</span>	<span class="number">899</span><span class="number">-99</span><span class="number">-9905</span>	<span class="number">1.1</span></span><br><span class="line"><span class="number">10</span>	<span class="number">899</span><span class="number">-99</span><span class="number">-9905</span>	<span class="number">1.1</span></span><br><span class="line"><span class="number">11</span>	<span class="number">899</span><span class="number">-99</span><span class="number">-9905</span>	<span class="number">1.1</span></span><br><span class="line"><span class="number">12</span>	<span class="number">899</span><span class="number">-99</span><span class="number">-9905</span>	<span class="number">1.1</span></span><br><span class="line"><span class="number">13</span>	<span class="number">899</span><span class="number">-99</span><span class="number">-9904</span>	<span class="number">1.23</span></span><br><span class="line"><span class="number">14</span>	<span class="number">899</span><span class="number">-99</span><span class="number">-9904</span>	<span class="number">1.254</span></span><br></pre></td></tr></table></figure>



<ol>
<li>当连接的筛选条件为 <code>uid = &#39;899-99-9904&#39;</code> 时，user_score 表中有两条可以关联的上，执行计划：</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span>  user_info ui <span class="keyword">join</span> user_score us <span class="keyword">on</span> us.uid = ui.uid <span class="keyword">where</span> ui.uid = <span class="string">'899-99-9904'</span>;</span><br><span class="line"></span><br><span class="line">id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra</span><br><span class="line">1	SIMPLE	ui	\N	ref	index_uid	index_uid	194	const	1	100	\N</span><br><span class="line">1	SIMPLE	us	\N	ref	index_uid	index_uid	194	const	2	100	Using index condition</span><br></pre></td></tr></table></figure>

<p>   <strong>可以看出，此时给出的执行计划， 驱动表 ui, 被驱动表 us 都是索引查询，使用的应该是 <code>Indexed Nested Loop Join</code> 连接算法。</strong></p>
<ol start="2">
<li>当连接的筛选条件为 <code>uid = &#39;899-99-9905&#39;</code> 时，user_score 表中有四条可以关联的上，执行计划：</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span>  user_info ui <span class="keyword">join</span> user_score us <span class="keyword">on</span> us.uid = ui.uid <span class="keyword">where</span> ui.uid = <span class="string">'899-99-9905'</span>;</span><br><span class="line"></span><br><span class="line">id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra</span><br><span class="line">1	SIMPLE	ui	\N	ref	index_uid	index_uid	194	const	1	100	\N</span><br><span class="line">1	SIMPLE	us	\N	ALL	index_uid	\N	\N	\N	6	66.67	Using where; Using join buffer (Block Nested Loop)</span><br></pre></td></tr></table></figure>

<p>   此时的执行计划， 连接算法使用的时 <code>Block Nested Loop Join</code> 连接算法 （参考 Mysql 使用手册 - <strong>8.2.1.6 Nested-Loop Join Algorithms</strong>），且 user_info 使用了索引；这时，会扫描 user_score  表一次，将 user_score 表中的每一条记录同 <code>Join Buffer</code> 连接缓冲区中的 user_info 表筛选出来的记录进行匹配，如果满足关联条件，返回。</p>
<p>   猜想：此时，查询优化器可能是从 uid 的索引的情况来看，user_score  表中 <code>uid = &#39;899-99-9905&#39;</code> 的记录占据了整个表的大部分，而且表本身比较小，此时，做一次全表扫描的性能可能是会更好。</p>
<p><strong>Mysql 查询优化器的工作是一个很复杂的工作流程、会考虑各种因素，参考表的统计信息，给出当前较优的执行计划。</strong></p>

                
            </div>
        </article>
    
</div>
<div class="paginator">
    
        
        
        <a class="next" href="/page/2/">
            Next
            <i class="iconfont icon-next"></i>
        </a>
        
    
</div>

    </div>
</div>
<footer class="footer-social">
    

    

    

    <div class="footer-copyright">
        <p class="time-line">
            &copy;
            
            
            2020
            &nbsp;<i class="iconfont icon-heart"></i>&nbsp;
            <a target="_blank" href="https://github.com/iJinxin">Guo</a>
        </p>
        <p class="theme-info">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme -
            <a target="_blank" href="https://github.com/iJinxin/hexo-theme-sky">Sky</a>
        </p>
    </div>
</footer>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    

</script>
</html>

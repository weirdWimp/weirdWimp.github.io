<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>The Cabin in the City</title>
    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_859455_eaq7v6w8ktj.css">
<meta name="generator" content="Hexo 4.2.1"></head>
<body>
<header class="header">
    <div class="header-inner">
        <div class="header-title">

        </div>
        <nav class="header-nav">
            
            <a href="/" class="header-nav-link" >
                Home
            </a>
            

            
            <a href="/archives" class="header-nav-link">
                Archives
            </a>
            

            
            <a href="/tags" class="header-nav-link">
                Tags
            </a>
            

            
            <a href="/about/" class="header-nav-link">
                About
            </a>
            
        </nav>
    </div>
</header>
<header class="mobile-header">
    <div class="mobile-nav">
        <div class="mobile-nav-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="mobile-nav-title">
            <a href="/" class="mobile-nav-title-link">'s Blog</a>
        </div>

    </div>
    <nav class="mobile-menu">
        <ul class="mobile-menu-list">
            <li class="mobile-menu-item">
                <i class="iconfont icon-home"></i>
                <a href="/" class="mobile-nav-link">Home</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-archive"></i>
                <a href="/archives" class="mobile-nav-link">Archives</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-tag"></i>
                <a href="/tags" class="mobile-nav-link">Tags</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-about"></i>
                <a href="/about/" class="mobile-nav-link">About</a>
            </li>
        </ul>
    </nav>
</header>
<div class="main">
    <div class="content-inner">
        <div class="posts">
    <article class="post-whole">
        <div class="post-title">
            <h2 class="title">Spring 事务</h2>
            <div class="post-meta">
                <span class="post-time">2021-07-25</span>
                
                <span class="post-category">
                    
                    <a class="category" href="/categories/Spring/">Spring</a>
                    
                </span>
                
                <span class="post-visit"> visited：<span id="busuanzi_value_page_pv"></span></span>
            </div>
        </div>
        <div class="post-toc" id="post-toc">
    <strong class="post-toc-title">目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一些简称或术语"><span class="toc-text">一些简称或术语</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-框架的事务抽象"><span class="toc-text">Spring 框架的事务抽象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TransactionManager"><span class="toc-text">TransactionManager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TransactionDefinition"><span class="toc-text">TransactionDefinition</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TransactionStatus"><span class="toc-text">TransactionStatus</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#声明式事务管理"><span class="toc-text">声明式事务管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-Transactional"><span class="toc-text">Using @Transactional</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Transactional-settings"><span class="toc-text">@Transactional settings</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编程式事务"><span class="toc-text">编程式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-TransactionTemplate"><span class="toc-text">使用 TransactionTemplate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-PlatformTransactionManager"><span class="toc-text">使用 PlatformTransactionManager</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-事务的传播行为"><span class="toc-text">Spring 事务的传播行为</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#错误的验证方式"><span class="toc-text">错误的验证方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#正确的验证方式"><span class="toc-text">正确的验证方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#将这两个事务性的方法声明在不同的-bean-中"><span class="toc-text">将这两个事务性的方法声明在不同的 bean 中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#通过代码显示控制事务的执行"><span class="toc-text">通过代码显示控制事务的执行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考阅读"><span class="toc-text">参考阅读</span></a></li></ol>
    <div class="back-to-top" id="back-to-top">
        <a href="javascript:void(0);">回到顶部</a>
    </div>
</div>
        <div class="post-content">
            <h2 id="一些简称或术语"><a href="#一些简称或术语" class="headerlink" title="一些简称或术语"></a>一些简称或术语</h2><p><strong>JTA</strong>  Java Transaction API</p>
<p><strong>EJB</strong>   Enterprise Java Beans</p>
<p><strong>CMT</strong> Container Managed Transaction</p>
<p>*<em>JMS *</em>  Java Message Service</p>
<p>*<em>JCA *</em>  Java EE Connector Architecture</p>
<p><strong>weave</strong> byte code modifition 字节码修改来增强类，提供切面，与基于代理的切面是完全不同的一种方式</p>
<h2 id="Spring-框架的事务抽象"><a href="#Spring-框架的事务抽象" class="headerlink" title="Spring 框架的事务抽象"></a>Spring 框架的事务抽象</h2><h3 id="TransactionManager"><a href="#TransactionManager" class="headerlink" title="TransactionManager"></a>TransactionManager</h3><p><code>TransactionManager</code>:  定义事务策略，例如，用于命令式事务管理的 <code>org.springframework.transaction.PlatformTransactionManager</code> 接口或者用于响应式事务管理的 <code>org.springframework.transaction.ReactiveTransactionManager</code> 接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PlatformTransactionManager</span> <span class="keyword">extends</span> <span class="title">TransactionManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">TransactionStatus <span class="title">getTransaction</span><span class="params">(TransactionDefinition definition)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">commit</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rollback</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="TransactionDefinition"><a href="#TransactionDefinition" class="headerlink" title="TransactionDefinition"></a>TransactionDefinition</h3><p><code>TransactionDefinition</code>: 定义事务的传播行为、隔离级别、超时时间、只读状态</p>
<p>传播行为(Propagation): </p>
<p>隔离级别(Isolation):</p>
<p>超时时间(Timeout):</p>
<p>只读状态(read-only):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionDefinition</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> PROPAGATION_REQUIRED = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> PROPAGATION_SUPPORTS = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">int</span> PROPAGATION_MANDATORY = <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">int</span> PROPAGATION_REQUIRES_NEW = <span class="number">3</span>;</span><br><span class="line">	<span class="keyword">int</span> PROPAGATION_NOT_SUPPORTED = <span class="number">4</span>;</span><br><span class="line">	<span class="keyword">int</span> PROPAGATION_NEVER = <span class="number">5</span>;</span><br><span class="line">	<span class="keyword">int</span> PROPAGATION_NESTED = <span class="number">6</span>;</span><br><span class="line">	<span class="keyword">int</span> ISOLATION_DEFAULT = -<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">int</span> ISOLATION_READ_UNCOMMITTED = <span class="number">1</span>;  <span class="comment">// same as java.sql.Connection.TRANSACTION_READ_UNCOMMITTED;</span></span><br><span class="line">	<span class="keyword">int</span> ISOLATION_READ_COMMITTED = <span class="number">2</span>;  <span class="comment">// same as java.sql.Connection.TRANSACTION_READ_COMMITTED;</span></span><br><span class="line">	<span class="keyword">int</span> ISOLATION_REPEATABLE_READ = <span class="number">4</span>;  <span class="comment">// same as java.sql.Connection.TRANSACTION_REPEATABLE_READ;</span></span><br><span class="line">	<span class="keyword">int</span> ISOLATION_SERIALIZABLE = <span class="number">8</span>;  <span class="comment">// same as java.sql.Connection.TRANSACTION_SERIALIZABLE;</span></span><br><span class="line">	<span class="keyword">int</span> TIMEOUT_DEFAULT = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">getPropagationBehavior</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> PROPAGATION_REQUIRED;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">getIsolationLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ISOLATION_DEFAULT;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">getTimeout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> TIMEOUT_DEFAULT;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">isReadOnly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function"><span class="keyword">default</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">static</span> TransactionDefinition <span class="title">withDefaults</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> StaticTransactionDefinition.INSTANCE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="TransactionStatus"><a href="#TransactionStatus" class="headerlink" title="TransactionStatus"></a>TransactionStatus</h3><p><code>TransactionStatus</code> ：为使用事务性的代码来控制事务的执行和查询事务状态提供了一种简单的方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionStatus</span> <span class="keyword">extends</span> <span class="title">TransactionExecution</span>, <span class="title">SavepointManager</span>, <span class="title">Flushable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isNewTransaction</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasSavepoint</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setRollbackOnly</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isRollbackOnly</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCompleted</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="声明式事务管理"><a href="#声明式事务管理" class="headerlink" title="声明式事务管理"></a>声明式事务管理</h2><p> While the Spring default behavior for declarative transaction management follows EJB convention (roll back is automatic only on unchecked exceptions), it is often useful to customize this behavior.</p>
<h3 id="Using-Transactional"><a href="#Using-Transactional" class="headerlink" title="Using @Transactional"></a>Using @Transactional</h3><p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#transaction-declarative-annotations" target="_blank" rel="noopener">https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#transaction-declarative-annotations</a></p>
<blockquote>
<p>You can apply the <code>@Transactional</code> annotation to an interface definition, a method on an interface, a class definition, or a public method on a class. However, the mere presence of the <code>@Transactional</code> annotation is not enough to activate the transactional behavior. The <code>@Transactional</code> annotation is merely metadata that can be consumed by some runtime infrastructure that is <code>@Transactional</code>-aware and that can use the metadata to configure the appropriate beans with transactional behavior. In the preceding example, the <code>&lt;tx:annotation-driven/&gt;</code> element switches on the transactional behavior.</p>
</blockquote>
<p><code>@Transactional</code> 注解只是配置事务行为的元数据，并不会激活这些事务行为，Spring 的事务框架会使用这些元数据为某些 bean 配置它们的事务行为，xml 文件中的 <code>&lt;tx:annotation-driven/&gt;</code> 和配置类（<code>@Configuration</code>）上的 <code>@EnableTransactionManagement</code>注解会激活这些事务行为。</p>
<blockquote>
<p><code>@EnableTransactionManagement</code> and <code>&lt;tx:annotation-driven/&gt;</code> looks for <code>@Transactional</code> only on beans in the same application context in which they are defined. This means that, if you put annotation-driven configuration in a <code>WebApplicationContext</code> for a <code>DispatcherServlet</code>, it checks for <code>@Transactional</code> beans only in your controllers and not your services. See <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-servlet" target="_blank" rel="noopener">MVC</a> for more information.</p>
</blockquote>
<p><code>@EnableTransactionManagement</code> and <code>&lt;tx:annotation-driven/&gt;</code> 只会在定义它们本身的上下文中寻找 <code>@Transactional</code> 注解的 bean， 如果是在 Web 应用的 <code>DispatcherServlet</code> 对应的 <code>WebApplicationContext</code> <code>@EnableTransactionManagement</code> and <code>&lt;tx:annotation-driven/&gt;</code>只会在这个上下文中查找，这个上下文一般只会定义控制器以及试图解析器等 web 组件，而不是 service 类。</p>
<blockquote>
<p>In proxy mode (which is the default), only external method calls coming in through the proxy are intercepted. This means that self-invocation (in effect, a method within the target object calling another method of the target object) does not lead to an actual transaction at runtime even if the invoked method is marked with <code>@Transactional</code>. Also, the proxy must be fully initialized to provide the expected behavior, so you should not rely on this feature in your initialization code (that is, <code>@PostConstruct</code>).</p>
</blockquote>
<p>由于 Spring 事务是基于代理的，只有通过代理的外部方法调用才会被拦截，目标对象内部的方法调用（一个方法调用对象内部的另一个方法）是不会在运行时导致一个实际的事务发生的；另外，必须完全初始化代理以提供预期的行为，因此不应在初始化代码（即@PostConstruct）中依赖此功能。</p>
<blockquote>
<p>Consider using of AspectJ mode (see the <code>mode</code> attribute in the following table) if you expect self-invocations to be wrapped with transactions as well. In this case, there no proxy in the first place. Instead, the target class is woven (that is, its byte code is modified) to turn <code>@Transactional</code> into runtime behavior on any kind of method.</p>
</blockquote>
<p>如果想要实现内部调用的事务行为，可以考虑基于 AspectJ 的 AOP, 首先，不会有代理，目标类被编织以将 <code>@Transactional</code> 的运行时行为应用于任何方法上</p>
<p><strong>使用基于代理的事务的 proxy 类型</strong></p>
<ul>
<li><p>class-based proxies </p>
</li>
<li><p>standard JDK interface-based proxies （default or omitted）</p>
</li>
</ul>
<h4 id="Transactional-settings"><a href="#Transactional-settings" class="headerlink" title="@Transactional settings"></a>@Transactional settings</h4><p>默认的<code>@Transactional</code> 的设置：</p>
<ul>
<li><p>The propagation setting is <code>PROPAGATION_REQUIRED.</code> #  默认的传播行为</p>
</li>
<li><p>The isolation level is <code>ISOLATION_DEFAULT.</code> # 默认的事务隔离级别</p>
</li>
<li><p>The transaction is read-write. # 模式是读-写的事务</p>
</li>
<li><p>The transaction timeout defaults to the default timeout of the underlying transaction system, or to none if timeouts are not supported. # 超时时间</p>
</li>
<li><p>Any <code>RuntimeException</code> triggers rollback, and any checked <code>Exception</code> does not. # 触发回滚的规则（异常类别）</p>
<p>fully-qualified class name </p>
</li>
</ul>
<h2 id="编程式事务"><a href="#编程式事务" class="headerlink" title="编程式事务"></a>编程式事务</h2><h3 id="使用-TransactionTemplate"><a href="#使用-TransactionTemplate" class="headerlink" title="使用 TransactionTemplate"></a>使用 TransactionTemplate</h3><p><code>TransactionTemplate</code> 和 Spring 中其他模板类相似（如 <code>JdbcTemplate</code>），目的是为了减少应用代码中获取和释放事务相关资源的样板式代码</p>
<p>（boilerplate acquisition and release transactional resources），这样应用就可以将关注点放在业务逻辑上。它使用一个回调方法。</p>
<p>应用代码必须执行在一个事务上下文（transactional context）中,  并且使用 <code>TransactionTemplate</code>，仅需两个步骤：</p>
<ol>
<li>应用代码编写  <code>TransactionCallback</code> 实现，这个实现中包含了事务要包含的所有的操作，通常是匿名内部类的形式 。</li>
<li>回调类实现的实例传入 <code>TransactionTemplate.execute(CallBack)</code> 方法中</li>
</ol>
<p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleService</span> <span class="keyword">implements</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// single TransactionTemplate shared amongst all methods in this instance</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TransactionTemplate transactionTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use constructor-injection to supply the PlatformTransactionManager</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleService</span><span class="params">(PlatformTransactionManager transactionManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.transactionTemplate = <span class="keyword">new</span> TransactionTemplate(transactionManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">someServiceMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> transactionTemplate.execute(<span class="keyword">new</span> TransactionCallback() &#123;</span><br><span class="line">            <span class="comment">// the code in this method executes in a transactional context</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">doInTransaction</span><span class="params">(TransactionStatus status)</span> </span>&#123;</span><br><span class="line">                updateOperation1();</span><br><span class="line">                <span class="keyword">return</span> resultOfUpdateOperation2();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>无返回的事务可以实现 <code>TransactionCallbackWithoutResult</code> 接口</p>
<p>事务的属性，如传播行为、隔离级别等可以通过  <code>TransactionTemplate</code> 提供的方法设置（程序中或XML中） </p>
<blockquote>
<p>Code within the callback can roll the transaction back by calling the <code>setRollbackOnly()</code> method on the supplied <code>TransactionStatus</code> object, as follows:</p>
</blockquote>
<p>也可以在回调方法中，调用 <code>TransactionStatus.setRollbackOnly()</code> 回滚事务,  这里取决于是否是新事务，来决定是否直接回滚。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">transactionTemplate.execute(<span class="keyword">new</span> TransactionCallbackWithoutResult() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doInTransactionWithoutResult</span><span class="params">(TransactionStatus status)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            updateOperation1();</span><br><span class="line">            updateOperation2();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SomeBusinessException ex) &#123;</span><br><span class="line">            status.setRollbackOnly();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h3 id="使用-PlatformTransactionManager"><a href="#使用-PlatformTransactionManager" class="headerlink" title="使用 PlatformTransactionManager"></a>使用 PlatformTransactionManager</h3><p>也可以提直接使用 <code>PlatformTransactionManager</code> 来管理事务，需要结合 Spring 事务抽象的其它对象： <code>TransactionDefinition</code>, <code>TransactionStatus</code>。 可以实现事务的初始化、回滚和提交。编程式事务也可以显示设置事务的名称，声明式的事务名称一般都是默认的全限定类名+方法名。</p>
<p>Java </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DefaultTransactionDefinition def = <span class="keyword">new</span> DefaultTransactionDefinition();</span><br><span class="line"><span class="comment">// explicitly setting the transaction name is something that can be done only programmatically</span></span><br><span class="line">def.setName(<span class="string">"SomeTxName"</span>);</span><br><span class="line">def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);</span><br><span class="line"></span><br><span class="line">TransactionStatus status = txManager.getTransaction(def);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// execute your business logic here</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (MyException ex) &#123;</span><br><span class="line">    txManager.rollback(status);</span><br><span class="line">    <span class="keyword">throw</span> ex;</span><br><span class="line">&#125;</span><br><span class="line">txManager.commit(status);</span><br></pre></td></tr></table></figure>



<p>在 <code>PlatformTransactionManager.rollback(TransactionStatus status)</code> 方法有如下的注释：</p>
<blockquote>
<p>Do not call rollback on a transaction if commit threw an exception. The transaction will already have been completed and cleaned up when commit  returns, even in case of a commit exception. Consequently, a rollback call after commit failure will lead to an IllegalTransactionStateException.</p>
</blockquote>
<p>不要在commit 时异常后进行回滚，commit 返回时（即使有提交异常），事务已经完成并且已经被清理。所以这时，如果调用 rollback 操作，会导致一个 <code>IllegalTransactionStateException</code>， 这也是上述示例代码中 commit 放在最后的原因</p>
<blockquote>
<p>If the transaction wasn’t a new one, omit the commit for proper participation in the surrounding transaction.</p>
</blockquote>
<p><strong>当调用了 commit 后，如果该事务不是一个新事务，则会忽略提交以正确参与周围的事务中。</strong></p>
<h2 id="Spring-事务的传播行为"><a href="#Spring-事务的传播行为" class="headerlink" title="Spring 事务的传播行为"></a>Spring 事务的传播行为</h2><p>具体的传播行为定义见 <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/data-access.html#tx-propagation" target="_blank" rel="noopener">Spring Transaction Propagation</a> 和 <a href="https://blog.csdn.net/soonfly/article/details/70305683" target="_blank" rel="noopener">CSDN-事务属性之7种传播行为</a>，不再赘述. 这里主要是对如何在 Spring 中验证这些传播行为的行为进行验证和说明:</p>
<p>假设相对 <code>PROPAGATION_NESTED</code> 嵌套事务传播行为进行验证, 首先需要设置对应的 TransactionManager 支持:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">    DataSourceTransactionManager dataSourceTransactionManager = <span class="keyword">new</span> DataSourceTransactionManager();</span><br><span class="line">    dataSourceTransactionManager.setDataSource(dataSource);</span><br><span class="line">    dataSourceTransactionManager.setNestedTransactionAllowed(<span class="keyword">true</span>); <span class="comment">// 允许嵌套事务</span></span><br><span class="line">    <span class="keyword">return</span> dataSourceTransactionManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="错误的验证方式"><a href="#错误的验证方式" class="headerlink" title="错误的验证方式"></a>错误的验证方式</h3><p>接下来,可能想当然的在一个 Service 类中定义如下两个事务方法, 并指定事务的传播行为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionTestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 注入对应 DAP 类,进行实际的数据库访问</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LearnSqlMapper sqlMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 第一个事务性的方法, 使用默认的传播行为,即 REQUIRED, 不存在事务时会创建一个新的事务.</span></span><br><span class="line"><span class="comment">    * 在当前方法中会调用第二个事务性方法,它的传播行为为 NESTED </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">outerTXBusiness</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserInfo userInfo = <span class="keyword">new</span> UserInfo(FakerUtil.getRandomId(), FakerUtil.getRandomName());</span><br><span class="line">        System.out.println(userInfo);</span><br><span class="line">        sqlMapper.insertToUserInfo(Collections.singletonList(userInfo));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 调用第二个事务性的方法</span></span><br><span class="line">        innerTXBusiness();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 第二个事务性的方法, 传播行为指定为 NESTED, 期望以一个嵌套子事务(逻辑事务)运行在已经存在的事务中 </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Transactional</span>(propagation = Propagation.NESTED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">innerTXBusiness</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"innerTXBusiness:"</span> + <span class="keyword">this</span>.getClass());</span><br><span class="line">        List&lt;UserInfo&gt; userInfos = IntStream.rangeClosed(<span class="number">1</span>, <span class="number">4</span>)</span><br><span class="line">                .mapToObj(i -&gt; <span class="keyword">new</span> UserInfo(FakerUtil.getRandomId(), FakerUtil.getRandomName()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        userInfos.forEach(System.out::println);</span><br><span class="line">        sqlMapper.insertToUserInfo(userInfos);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 这里抛出一个 DataAccessException 或其它 RuntimeExcpetion 期望进行此嵌套子事务可以回滚到 savepoint</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BadSqlGrammarException(<span class="string">"task"</span>, <span class="string">"sql"</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>当在其它的 bean 中调用 <code>TransactionTestService</code> bean 的 <code>outerTXBusiness</code> 方法时, 会发现 <code>outerTXBusiness</code> 和  <code>innerTXBusiness</code> 中所有的操作都被回滚了, 不是预期的 <code>NESTED</code> 传播行为 (内部的嵌套子事务的回滚, 只是回滚到执行前的一个 savepoint, 并不会导致整个事务回滚), 预期中, <code>outerTXBusiness</code> 中的插入数据库操作不会被回滚的.</p>
<p>造成这种现象的原因其实也很简单, 因为 <code>innerTXBusiness</code> 方法根本没有被应用事务的切面通知 (advice, 或者说拦截), 因为属于方法内部调用, 基于代理的 Spring AOP 是不会对这种内部调用应用事务通知的 (Spring 事务是基于 AOP 的).</p>
<h3 id="正确的验证方式"><a href="#正确的验证方式" class="headerlink" title="正确的验证方式"></a>正确的验证方式</h3><p>要进行验证, 可以使用三种方式: </p>
<ol>
<li>切换 Spring AOP 使用 AspectJ 集成 (方法内的调用可以被拦截),</li>
<li>继续使用基于代理的 Spring AOP, 将这两个事务性的方法声明在不同的 bean 中</li>
<li>继续使用基于代理的 Spring AOP, 使用编程式的事务管理</li>
</ol>
<p>第一种就不做尝试了, 看下后面两种的实现:</p>
<h4 id="将这两个事务性的方法声明在不同的-bean-中"><a href="#将这两个事务性的方法声明在不同的-bean-中" class="headerlink" title="将这两个事务性的方法声明在不同的 bean 中"></a>将这两个事务性的方法声明在不同的 bean 中</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TX1Service</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LearnSqlMapper sqlMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> TX2Service tx2Service;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span>(propagation = Propagation.REQUIRED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">outerTXBusiness</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserInfo userInfo = <span class="keyword">new</span> UserInfo(FakerUtil.getRandomId(), FakerUtil.getRandomName());</span><br><span class="line">        sqlMapper.insertToUserInfo(Collections.singletonList(userInfo));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 调用第二个事务性方法</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            tx2Service.innerTXBusiness();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"e from innerTXBusiness:"</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TX2Service</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LearnSqlMapper sqlMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指定传播行为为 NESTED</span></span><br><span class="line">    <span class="meta">@Transactional</span>(propagation = Propagation.NESTED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">innerTXBusiness</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;UserInfo&gt; userInfos = IntStream.rangeClosed(<span class="number">1</span>, <span class="number">4</span>)</span><br><span class="line">                .mapToObj(i -&gt; <span class="keyword">new</span> UserInfo(FakerUtil.getRandomId(), FakerUtil.getRandomName()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        userInfos.forEach(System.out::println);</span><br><span class="line">        sqlMapper.insertToUserInfo(userInfos);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 抛出异常, 验证嵌套子事务回滚到 savepoint 的情况</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"RuntimeException from outerTXBusiness"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>当在其它 bean 中 调用 <code>TX1Service#outerTXBusiness()</code> 时, 可以看到正确的行为, 即  <code>TX2Service#innerTXBusiness()</code> 中的操作被回滚,  <code>TX1Service#outerTXBusiness()</code> 中的插入成功, 并没有影响外部事务的操作.</p>
<p>![image-20210725142848456](D:\Markdown 目录\Markdown 文档\工作\Spring\img-assets\image-20210725142848456.png)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">2021-07-25 14:20:45.701 DEBUG 5248 --- [nio-8080-exec-1] o.s.j.d.DataSourceTransactionManager     : Creating new transaction with name [com.example.springboot.demo.service.impl.TX1Service.outerTXBusiness]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT</span><br><span class="line">2021-07-25 14:20:45.702 DEBUG 5248 --- [nio-8080-exec-1] o.s.j.d.DataSourceTransactionManager     : Acquired Connection [com.mysql.jdbc.JDBC4Connection@74367762] for JDBC transaction</span><br><span class="line">2021-07-25 14:20:45.704 DEBUG 5248 --- [nio-8080-exec-1] o.s.j.d.DataSourceTransactionManager     : Switching JDBC Connection [com.mysql.jdbc.JDBC4Connection@74367762] to manual commit</span><br><span class="line">2021-07-25 14:20:45.873 DEBUG 5248 --- [nio-8080-exec-1] c.e.s.d.m.L.insertToUserInfo             : &#x3D;&#x3D;&gt;  Preparing: insert into user_info (uid, name) values (?, ?) </span><br><span class="line">2021-07-25 14:20:45.888 DEBUG 5248 --- [nio-8080-exec-1] c.e.s.d.m.L.insertToUserInfo             : &#x3D;&#x3D;&gt; Parameters: 882-12-3146(String), Mr. Boris Swaniawski(String)</span><br><span class="line">2021-07-25 14:20:45.893 DEBUG 5248 --- [nio-8080-exec-1] c.e.s.d.m.L.insertToUserInfo             : &lt;&#x3D;&#x3D;    Updates: 1</span><br><span class="line">2021-07-25 14:20:45.894 DEBUG 5248 --- [nio-8080-exec-1] o.s.j.d.DataSourceTransactionManager     : Creating nested transaction with name [com.example.springboot.demo.service.impl.TX2Service.innerTXBusiness]</span><br><span class="line">UserInfo&#123;id&#x3D;0, uid&#x3D;&#39;120-27-6630&#39;, name&#x3D;&#39;Joanne Greenfelder&#39;&#125;</span><br><span class="line">UserInfo&#123;id&#x3D;0, uid&#x3D;&#39;874-91-6406&#39;, name&#x3D;&#39;Dr. Conrad Hessel&#39;&#125;</span><br><span class="line">UserInfo&#123;id&#x3D;0, uid&#x3D;&#39;122-56-3491&#39;, name&#x3D;&#39;Brittni Emmerich&#39;&#125;</span><br><span class="line">UserInfo&#123;id&#x3D;0, uid&#x3D;&#39;360-27-3198&#39;, name&#x3D;&#39;Dr. Damien Conroy&#39;&#125;</span><br><span class="line">2021-07-25 14:20:45.915 DEBUG 5248 --- [nio-8080-exec-1] c.e.s.d.m.L.insertToUserInfo             : &#x3D;&#x3D;&gt;  Preparing: insert into user_info (uid, name) values (?, ?) , (?, ?) , (?, ?) , (?, ?) </span><br><span class="line">2021-07-25 14:20:45.915 DEBUG 5248 --- [nio-8080-exec-1] c.e.s.d.m.L.insertToUserInfo             : &#x3D;&#x3D;&gt; Parameters: 120-27-6630(String), Joanne Greenfelder(String), 874-91-6406(String), Dr. Conrad Hessel(String), 122-56-3491(String), Brittni Emmerich(String), 360-27-3198(String), Dr. Damien Conroy(String)</span><br><span class="line">2021-07-25 14:20:45.921 DEBUG 5248 --- [nio-8080-exec-1] c.e.s.d.m.L.insertToUserInfo             : &lt;&#x3D;&#x3D;    Updates: 4</span><br><span class="line">2021-07-25 14:20:45.921 DEBUG 5248 --- [nio-8080-exec-1] o.s.j.d.DataSourceTransactionManager     : Rolling back transaction to savepoint</span><br><span class="line">2021-07-25 14:20:45.923 ERROR 5248 --- [nio-8080-exec-1] c.e.s.demo.service.impl.TX1Service       : e from innerTXBusiness:RuntimeException from outerTXBusiness</span><br><span class="line">2021-07-25 14:20:45.923 DEBUG 5248 --- [nio-8080-exec-1] o.s.j.d.DataSourceTransactionManager     : Initiating transaction commit</span><br><span class="line">2021-07-25 14:20:45.923 DEBUG 5248 --- [nio-8080-exec-1] o.s.j.d.DataSourceTransactionManager     : Committing JDBC transaction on Connection [com.mysql.jdbc.JDBC4Connection@74367762]</span><br><span class="line">2021-07-25 14:20:45.928 DEBUG 5248 --- [nio-8080-exec-1] o.s.j.d.DataSourceTransactionManager     : Releasing JDBC Connection [com.mysql.jdbc.JDBC4Connection@74367762] after transaction</span><br></pre></td></tr></table></figure>





<h4 id="通过代码显示控制事务的执行"><a href="#通过代码显示控制事务的执行" class="headerlink" title="通过代码显示控制事务的执行"></a>通过代码显示控制事务的执行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionTestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LearnSqlMapper sqlMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PlatformTransactionManager transactionManager;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">outerBiz1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserInfo userInfo = <span class="keyword">new</span> UserInfo(FakerUtil.getRandomId(), FakerUtil.getRandomName());</span><br><span class="line">        sqlMapper.insertToUserInfo(Collections.singletonList(userInfo));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">outerBiz2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BadSqlGrammarException(<span class="string">"task"</span>, <span class="string">"sql"</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">innerBiz</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;UserInfo&gt; userInfos = IntStream.rangeClosed(<span class="number">1</span>, <span class="number">4</span>)</span><br><span class="line">                .mapToObj(i -&gt; <span class="keyword">new</span> UserInfo(FakerUtil.getRandomId(), FakerUtil.getRandomName()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        userInfos.forEach(System.out::println);</span><br><span class="line">        sqlMapper.insertToUserInfo(userInfos);</span><br><span class="line">        <span class="comment">// throw new BadSqlGrammarException("task", "sql", null);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过显示的代码来控制事务的执行，来验证事务的传播行为</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nestedTXTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TransactionDefinition outerTXDef = createTXDefinition(<span class="string">"OuterTX"</span>, TransactionDefinition.PROPAGATION_REQUIRED);</span><br><span class="line">        TransactionStatus outerStatus = transactionManager.getTransaction(outerTXDef);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            txExecute(outerStatus, () -&gt; &#123;</span><br><span class="line">                outerBiz1();</span><br><span class="line"></span><br><span class="line">                innerTXOperation();</span><br><span class="line"></span><br><span class="line">                outerBiz2();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"OuterTX exception"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">innerTXOperation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TransactionDefinition innerTXDef = createTXDefinition(<span class="string">"InnerTX"</span>, TransactionDefinition.PROPAGATION_NESTED);</span><br><span class="line">        TransactionStatus innerStatus = transactionManager.getTransaction(innerTXDef);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            innerBiz();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage() + <span class="string">" from innerTXOperation"</span>);</span><br><span class="line">            transactionManager.rollback(innerStatus);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 当调用了 commit 后，如果该事务不是一个新事务，则会忽略提交以正确参与周围的事务中</span></span><br><span class="line">        transactionManager.commit(innerStatus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@FunctionalInterface</span></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">TXOperation</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">txExecute</span><span class="params">(TransactionStatus status, TXOperation txOperations)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            txOperations.apply();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            transactionManager.rollback(status);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当调用了 commit 后，如果该事务不是一个新事务，则会忽略提交以正确参与周围的事务中</span></span><br><span class="line">        <span class="comment">// 所以按照模板式的使用就可以了，不必关心如何参与到已经存在的事务中，只需要定义正确的 TransactionDefinition (包括传播行为，隔离级别等)</span></span><br><span class="line">        transactionManager.commit(status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TransactionDefinition <span class="title">createTXDefinition</span><span class="params">(String name, <span class="keyword">int</span> propagation)</span> </span>&#123;</span><br><span class="line">        DefaultTransactionDefinition definition = <span class="keyword">new</span> DefaultTransactionDefinition();</span><br><span class="line">        definition.setName(name);</span><br><span class="line">        definition.setPropagationBehavior(propagation);</span><br><span class="line">        definition.setIsolationLevel(TransactionDefinition.ISOLATION_DEFAULT);</span><br><span class="line">        <span class="keyword">return</span> definition;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="参考阅读"><a href="#参考阅读" class="headerlink" title="参考阅读"></a>参考阅读</h2><p>[1] <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/data-access.html#tx-propagation" target="_blank" rel="noopener">Data Access (spring.io)</a></p>
<p>[2] <a href="https://blog.csdn.net/soonfly/article/details/70305683" target="_blank" rel="noopener">CSDN-事务的传播行为</a></p>

        </div>
        
        <div class="post-tag">
            
            <a class="tag" href="/tags/Spring/" title="Spring">Spring</a>
            
        </div>
        
    </article>
</div>
<div class="paginator">
    
        
        
            <a class="next" href="/Spring/Spring%20AOP%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
                <span class="nav-default">Spring AOP 源码分析</span>
                <span class="nav-mobile">Next</span>
                <i class="iconfont icon-next"></i>
            </a>
        
    
</div>
<div id="comment-container"></div>
    </div>
</div>
<footer class="footer-social">
    
    <a class="social-link" target="_blank" href="https://github.com/weirdwimp">
        <i class="iconfont icon-github"></i>
    </a>
    

    

    

    <div class="footer-copyright">
        <p class="time-line">
            &copy;
            
            
            2021
            &nbsp;<i class="iconfont icon-heart"></i>&nbsp;
            <a target="_blank" href="https://github.com/iJinxin"></a>
        </p>
        <p class="theme-info">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme -
            <a target="_blank" href="https://github.com/iJinxin/hexo-theme-sky">Sky</a>
        </p>
    </div>
</footer>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    

</script>
</html>
